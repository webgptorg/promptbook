-   Updated Agents Server chat tool-call streaming so tool-call chips now appear while the assistant message is still streaming (not only after completion), with a shared DRY tool-call stream emitter for both ongoing and final snapshots plus unified chip-label logic used by ongoing and completed chips.
-   Added a new `MESSAGE SUFFIX` commitment with multiline support, wired it into commitment registry/parsing (`parseAgentSource.meta.messageSuffix`), and implemented DRY Agents Server runtime handling that appends the suffix to every assistant reply in native chat plus OpenAI/OpenRouter compatibility modes, including emulated streaming of the suffix chunks so it appears progressively in streamed responses.
-   Added a new `META DISCLAIMER` commitment with multiline Markdown support, wired parser/registry support in core, and implemented Agents Server disclaimer enforcement end-to-end: users must acknowledge the disclaimer before chat/voice requests proceed, agreement is persisted per user+agent in `UserData`, and chat surfaces now show a blocking pre-chat disclaimer modal with an explicit `I Agree` action.
-   Implemented global server search in Agents Server with a pluggable provider architecture (agents profile+book, federated-agent profiles, folders, conversations, documentation, metadata, users, messages/files/images, and navigation links), added the new `/api/search` aggregated endpoint, and integrated a debounced header search UX (desktop + mobile) with grouped icon-based results, contextual snippets, and direct entity links.
-   Fixed Agents Server header submenu usability across hierarchy and menu dropdowns: the desktop hierarchy now opens by hover (including agent-view crumbs), mobile parent items now toggle nested subitems with clear indentation, and both hierarchy/menu mobile rendering now reuse one shared DRY recursive submenu renderer.
-   Improved Agents Server chat switching UX by removing route-refresh navigation during in-page chat changes (URL now updates via history state), adding DRY chat activation/caching flow for instant revisits, delaying switch overlays to avoid flicker, and wiring the in-chat `New chat` action to create a fresh chat entry instead of resetting/mutating the current conversation.
-   Fixed Agents Server chat-history recording for canonicalized agent routes by resolving `agentName` from either route `agentName` or `permanentId` before inserts, so `ChatHistory` writes no longer fail with `ChatHistory_agentName_fkey` violations; also reused the same resolver in feedback handling to keep agent-identifier resolution DRY across endpoints.
-   Fixed RemoteAgent streaming tool-call parsing for large/split `{"toolCalls":...}` frames: chunk-fragmented tool payload lines are now buffered and parsed once complete, preventing raw JSON blobs from leaking into assistant message text and preserving tool-call chips in Agents Server chat.
-   Scoped Agents Server client-version enforcement to frontend browser traffic only, so OpenAI/OpenRouter compatibility routes (and other API-key/API requests) no longer require the latest Promptbook client while the frontend refresh-mismatch protection remains in place.
-   Fixed the Agents Server anonymous profile/chat pages in private windows by stopping render-time anonymous cookie writes (`ensureChatHistoryIdentity` now only checks availability); anonymous identity cookie creation remains in Route Handlers where Next.js allows cookie mutation.
-   Fixed Agents Server menu stacking order: agent context menus now render above agent cards in the homepage folder/list view, while the mobile hamburger menu remains above agent-related overlays (including the profile context-menu trigger layer).
-   Refined the Agents Server desktop collapsed My chats sidebar to prevent overflow by switching to compact avatar-first chat cards, keeping timestamps readable in the narrow rail, and reusing one shared chat-item content resolver for both collapsed and expanded sidebar layouts.
-   Fixed Agents Server chat-history persistence by introducing a shared DRY recorder for chat, voice, and OpenAI-compatible endpoints that now consistently captures message hashes/telemetry, logs insert failures instead of silently swallowing them, and falls back when optional `ChatHistory` columns are missing; also added an idempotent migration to ensure `ChatHistory.source` and `ChatHistory.apiKey` exist with the expected `source` constraint.
-   Added a new `USE USER LOCATION` commitment with a `get_user_location` tool, wired hidden runtime-context support for browser geolocation, and integrated Agents Server on-demand location prompting so the browser requests location only after the agent explicitly asks for it.
-   Added dual Agents Server application-error variants (`simple` and `advanced`) with shared DRY rendering helpers, and wired the Next.js app error boundary to report every captured failure to Sentry through the new `/api/error-reports/application` forwarding endpoint.
-   Fixed Agents Server TypeScript compatibility regressions across header submenu timers, homepage graph/list layout typing, anonymous user cookie/header helpers (Next async runtime APIs), user-memory identity fallback typing, metadata default lookup typing, and `<LlmChat/>` prompt parameter typing so `npx tsc --noEmit` no longer fails on these strict type errors.
-   Enabled the Agents Server desktop chat area to stay interactive while the sidebar remains open by keeping the backdrop overlay visual-only (pointer-events disabled), eliminating the auto-close-on-click behavior that previously closed the panel, while leaving the mobile overlay dismiss flow unchanged.
-   Added a private mode toggle to the control panel so chats, memories, and self-learning stay local when it‚Äôs enabled, the My chats preview displays a dedicated private indicator, and the server chat/voice/OpenAI-compatible APIs plus the user-chat/user-memory endpoints skip writing any data while the private-mode cookie is present.
-   Added a Control Panel self-learning toggle so administrators can pause the book-editing flow for their agents while continuing to save chats and memories, and wired `selfLearningEnabled` prompt parameters through RemoteAgent so the server skips the automatic self-learning hook whenever the switch is off.
-   Added user profile avatars to the Agents Server: users can now set a `profileImageUrl` via the new System ‚Üí Profile page (backed by `/api/profile`), the header displays that image instead of the placeholder initial, and the System menu exposes the Profile link next to the existing User Memory entry.
-   Added anonymous chat persistence in the Agents Server: guests now get `anonymous-<base58>` usernames stored in cookies, the user-chat/memory services reuse the shared identity resolver, and the My chats sidebar surfaces the same list for anonymous users as it does for signed-in accounts.
-   Added a shared `textToPreviewText` helper so chat previews (history cards, quick-access shortcuts, etc.) reuse the same Markdown sanitization pipeline as voice previews while keeping the JSON storage layer DRY.
-   Fixed the Agents Server header breadcrumb so folders show the folder icon instead of a single-letter placeholder when no agent avatar is available.
-   Reduced Agents Server homepage cold-start latency by introducing a `getMetadataMap` helper so the layout, federated-server lookup, and chat-preference helpers now read their metadata in a single Supabase round-trip instead of multiple sequential queries.
-   Added a shared `SidebarToggleArrow` component for the Agents Server and anchored it to the middle of the desktop chat sidebar so the open/close affordance always reuses a single arrow implementation.
-   Centered the desktop chat sidebar toggle over the chat‚Äôs left panel so the open/closing arrow now lives inline with the main chat surface while keeping the shared arrow component intact.
-   Fixed the Agents Server header Documentation and System dropdown subitems so nested panels float outside the scrollable dropdown instead of getting clipped behind the first-level container.
-   Centered the Agents Server desktop header navigation so the middle menu items stay locked in the visual center of the panel regardless of how wide the surrounding sections become.
-   Added a build-time prerender step for the Agents Server homepage (`/`) so `npm run build`/`npm run test-build` spin up the production server, capture the rendered HTML, and save it under `.next/prerendered/home.html`.
-   Improved the Agents Server desktop collapsed chat strip so each chat now shows a short title/preview/timestamp badge (and the strip slightly widens) while the mobile sidebar return path stays unchanged.
-   Fixed the Agents Server mobile chat history edge handle so tapping the floating arrow reuses the same sidebar list as desktop, always renders the readable title/preview/timestamp layout, and keeps the vertical strip hidden until the mobile overlay is opened.
-   Removed the redundant desktop chat history/book headers in Agents Server so the desktop view no longer shows the extra panel below the main menu while mobile layouts remain unchanged.
-   Removed the redundant `USE IMAGE GENERATION`, `USE IMAGE`, and `IMAGE GENERATOR` commitment aliases so only the working `USE IMAGE GENERATOR` commitment remains, reducing confusion for users and contributors.
-   Added CDN-friendly caching headers on the Agents Server homepage (`/`) so Vercel can pre-render that route with `s-maxage`/`stale-while-revalidate` and the first visitor no longer hits a cold SSR run.
-   Snapped the Agents Server footer to the bottom of the viewport so the layout no longer leaves the footer floating mid-page when the content is short.
-   Added a global version-mismatch experience that surfaces a friendly refresh notice, prevents the old chat-only message, and automatically reloads the page whenever the server requires a newer client release.
-   Added a custom Agents Server application error page with a branded layout, digest tracking, and proactive troubleshooting guidance for failed navigations.
-   Ensured Agents Server chat uploads now hand the generated CDN URL back to the client instead of the experimental short-link alias so attached files are accessible to agents outside the browser.
-   Improved the Agents Server chat history drawer: the left panel now slides with smoother animation, auto-closes when you tap outside, sits atop the header instead of being cropped, and exposes a mobile edge handle plus a minimal desktop strip so chats stay accessible without the extra top bar.
-   Added in-chat map rendering for GeoJSON features so agent replies that include \`\`\`geojson\`\`\` blocks now render a Leaflet map inside the bubble that zooms to the provided feature/collection.
-   Fixed the chat GeoJSON renderer so Leaflet overlays draw their features as soon as they're ready instead of showing a bare map for several seconds by invalidating the map size once the layer is initialized.
-   Expanded the chat GeoJSON map bubble so it stretches wider on desktop and mobile and added a control that opens the same Leaflet rendering in a responsive modal for a closer look.
-   Polished chat GeoJSON feature rendering so generated points of interest show glowing markers with tooltip initials, lines and polygons gain richer strokes/fills, and hover highlights keep each feature visually focused.
-   Hid streaming-only rich-feature markup (maps, inline image prompts, math/code fences, etc.) so the chat keeps streaming the human-readable text while the feature materializes instead of dumping raw GeoJSON or image prompt source, and the completed rendering appears once the assistant finishes.
-   Stopped `STREAM_KEEP_ALIVE` heartbeats from ever reaching `<Chat/>` by filtering them inside `RemoteAgent` so keep-alive pings stay hidden while preserving the underlying connection health signals.
-   Ensured the Agents Server chat reset option now just opens a new chat instead of re-inserting the failed message, so the ‚ÄúReset‚Äù button clears the conversation without duplicating the input.
-   Updated Agents Server `/admin/api-tokens` token rows to use the shared `<SecretInput/>` control, so API tokens are masked by default and can be toggled visible/hidden with the eye icon while keeping copy-to-clipboard inline.
-   Added `--priority <minimum-priority>` to `scripts/run-codex-prompts` so coding tasks can be filtered by priority threshold (default `0` keeps current behavior), and updated runner stats to show skipped runnable tasks as `Priority <N` while preserving `--agent`/`--model` behavior.
-   Fixed `USE IMAGE GENERATOR` to follow notation-only behavior: agents are now instructed to output `![alt](?image-prompt=...)` placeholders (instead of calling a generation tool), while the UI keeps generating images from that notation.
-   Refactored Agents Server image generation cache/lock flow into a shared `ensureGeneratedImage` utility and reused it in both `/api/images/[filename]` and default-agent-avatar generation, so lock waiting, stale-lock cleanup, and cache-first behavior are DRY and consistent.
-   Fixed Agents Server chat action button fading so `New chat` / `Save` are no longer stuck dimmed: overlap detection now checks the real message content block instead of the full-width message row, keeping fade only when buttons truly cover message content.
-   Redesigned the Agents Server header navigation into a hierarchy-first flow (`Server > Agent > Profile/Chat/Book`), moved server branding to the left edge, moved Users under `System`, renamed menu entries to `Landing page` and `Version info`, and removed the duplicated in-page `Chat/Source` switcher buttons from chat/book views.
-   Fixed Agents Server header folder flyout navigation so nested submenu columns are no longer clipped behind the first-level dropdown container, while keeping standard non-flyout dropdowns scrollable.
-   Fixed Agents Server profile-chat handoff with history enabled by introducing a profile-origin `newChat=1` flow: both typed messages and quick `?message=...` starts now always bootstrap a fresh chat and auto-send the message instead of occasionally landing in an existing chat without execution.
-   Fixed Book editor instant teammate creation for unresolved `TEAM` references in Agents Server: creating `Create {name}` now refreshes reference diagnostics immediately (no stale resolver cache), ignores soft-deleted duplicates when checking existing agents, updates the missing-teammate panel reliably right after creation, and encodes agent identifiers during folder lookups so newly created teammates stay in the same folder even when the current agent uses a non-canonical name.
-   Fixed the coding-agent runner progress header so it stays pinned in a dedicated top terminal line (white background) while agent CLI output continues streaming in real time below it, and refactored the progress line calculations into a shared DRY helper.
-   Added a shared secret input component to the Agents Server so login, change-password, admin auth, user creation, and token copy panels can reuse the same visibility toggle for passwords and API keys.
-   Fixed backgrounding on small devices by adding keep-alive pings to the Agents Server chat stream and teaching RemoteAgent to ignore the heartbeat token (`STREAM_KEEP_ALIVE`), so long-running replies stay connected even if the user switches away and returns later.
-   Added visibility-aware recovery in `<LlmChat/>` so backgrounded streaming responses no longer surface a ‚Äúconnection error‚Äù dialog; the interrupted prompt is retried automatically when the tab becomes visible again and the previous assistant message continues streaming.
-   Fixed the remaining Samsung Internet chat overflow root cause by tightening shared `<Chat/>` width constraints (removing `100vw` sizing, applying `min-width: 0` on flex/grid boundaries, and capping bubble width by `avatar + gap` math) and stabilized emoji font loading by switching OpenMoji `@font-face` in `Chat.module.css` to local-first sources with CDN fallback.
    -### üìö Book

-   Implemented persistent `MEMORY` commitment support in Agents Server end-to-end: `MEMORY` now registers hidden retrieve/store memory tools (with optional per-commitment instructions), stores data in the new `UserMemory` table (per user + per agent, with global-memory option), disables memory automatically for unauthenticated users and TEAM conversations, shows memory tool chips with stored/retrieved content, adds `System -> User Memory` CRUD UI for logged-in users, and wires admin (`ADMIN_PASSWORD`) memory identity with automatic DB-user linking.
-   Expanded the Agents Server memory experience by soft-deleting records (`deletedAt` column + migration), preferring agent-scoped entries by default, and teaching the MEMORY commitment to use new `update_user_memory` / `delete_user_memory` tools so each agent can edit or retire its own memories (global entries stay optional and shared).
-   Added per-user, per-agent chat history in Agents Server with a new `UserChat` table and migration: standalone chat now supports creating/resuming/deleting chats, stores full chat message arrays as JSON, keeps `?chat=<id>` URL routing (including fallback to most-recent chat when missing/invalid), orders chats by latest activity, creates a fresh chat when starting from the profile page, and keeps history disabled for unauthenticated users while preserving existing global `ChatHistory` logging.
-   Polished the Agents Server chat HTML export so the downloaded file mirrors the live chat experience with a hero banner, stat grid, bubble cards, avatars, attachments/citations, and embedded illustrations, making exports shareable instead of the previous bare layout.
-   Fixed Agents Server chat PDF downloads so the Save menu now produces a valid file (powered by a reusable jsPDF exporter that reuses the text/plain renderer) instead of the previous placeholder string, delivering real downloads in every chat.
-   Enhanced the Agents Server chat PDF export so the saved file preserves the agent background, colored message bubbles, avatars, and a branded print header, letting the exported chat mirror the live conversation instead of looking like plain text.
-   Added a System ‚Üí About entry that opens the new `/admin/about` page so admins can view shared Promptbook, system, and deployment version cards without hunting through the menu.
-   Moved the Models navigation link into System ‚Üí Models in the Agents Server header so admins keep a single System dropdown while maintaining quick access to model management.
-   When admins set up or update passwords in Agents Server (setup flow plus the admin users/change-password screens), weak passwords now surface the validation message (e.g., minimum length/format) instead of a generic ‚ÄúInternal server error‚Äù, so it‚Äôs clear what to fix before retrying.
-   Added a `BookEditable` helper to keep `KNOWLEDGE` insertions (from uploads) positioned just before the `CLOSED` commitment instead of at the very end of the book.
-   Enabled clickable agent references in the Book editor: `@agent`, `{agent name}`, `{agentId}`, `https://.../agents/...`, and `{https://.../agents/...}` now share one highlight style and open the referenced agent via Ctrl/Cmd+Click.
-   Fixed Samsung Internet rendering issues in the Agents Server by replacing `w-screen` route shells with a shared viewport-width-safe class, switching affected full-height routes to `100dvh`-based sizing, and improving font fallbacks/loading (`font-display: swap`, emoji fallback stack, and text autosize normalization) to prevent horizontal overflow and inconsistent font rendering on mobile Samsung browsers.
-   Added unresolved-reference diagnostics to the Agents Server Book editor: missing compact agent references in `FROM`, `TEAM`, and `IMPORT` commitments are now underlined red (Monaco error markers) while keeping links clickable, powered by a new shared DRY resolver-based diagnostics utility and API endpoint.
-   Added a Book editor right panel for unresolved TEAM references so admins immediately see ‚ÄúTeam member {name} is not found. Do you want to create it?‚Äù prompts and can hit `Create {name}` to spin up a folder-aware boilerplate agent, refresh diagnostics, and resolve the teammate without leaving the editor.
-   Ensured the instant teammate creation panel always reflects the exact token (e.g., `{Lawyer}`/`@lawyer`) and re-runs diagnostics with a cache-busting refresh so the card disappears as soon as the resolver detects the freshly created agent.
-   Fixed global agent route canonicalization in Agents Server: opening `/agents/:agentId` now resolves compact references through the shared local/federated resolver, redirects names and normalized-name variants to canonical `/agents/<permanentId>`, redirects federated hits to the correct remote server URL, and returns 404 when unresolved.
-   Hardened missing referenced-agent handling across `FROM`, `IMPORT`, and `TEAM` in Agents Server: compact references that cannot be resolved are now tracked through a shared DRY resolver-issue abstraction, inheritance/import processing no longer crashes and emits visible `NOTE` warnings instead, unresolved TEAM references are shown as `(not found)` capability chips without teammate URLs, and model-requirements flows now safely degrade instead of breaking the whole agent.
-   Allowed Agents Server TEAM references to still resolve private teammates hosted on the same server by falling back to a local agent lookup when compact references report issues, so local teammates stay reachable even when their visibility is private while federated servers continue to require public agents.
-   Strengthened source citation behavior in Agents Server chat: AgentKit instructions now append a shared citation policy whenever knowledge/web tools are active, and chat post-processing now preserves parsed citations before humanization so source chips remain visible instead of being dropped.
-   Simplified Agents Server knowledge chips by trimming CDN filenames to the first 20 characters (after dropping the extension), removing any trailing `isHumanOrID`-detected IDs, and keeping the original name for the tooltip via the new `simplifyKnowledgeLabel` helper.
-   Fixed knowledge chip simplification where it previously affected only agent capability chips: chat source chips now use the same shared `simplifyKnowledgeLabel`/`isHumanOrID` utility (moved to `src/utils/knowledge`) so CDN document citations finally hide random ID suffixes and show clean 20-character labels.
-   Expanded Agents Server chat citation parsing to support simplified source markers like `„Äêdocument123.doc„Äë` in addition to full OpenAI markers like `„Äê7:15‚Ä†document123.doc„Äë`; both now reuse a shared DRY normalization utility, resolve to the same source-chip pipeline, and keep citation links working against agent knowledge documents.
-   Fixed duplicated tool call chips (including empty first chips) in Agents Server chat by streaming only finalized tool call payloads to the client, so each invocation now renders a single correct chip while still showing distinct chips for distinct calls.
-   Fixed Agents Server chat feedback saving by resolving agent identifiers to canonical names (fixing foreign key violations) and correctly extracting the user's IP from the `x-forwarded-for` header, ensuring successful database insertion.
-   Improved the Agents Server chat feedback toast to report the actual server response (green on 201, red with the returned message on errors), and fixed its positioning to sit above the sticky header and menus with an increased z-index.
-   Enforced a client-version handshake across Agents Server chat, voice, and OpenAI-compatible endpoints: every request must now send `x-promptbook-client-version`, outdated clients get an inline update message inside the chat, and our Vercel deployment always serves the `PROMPTBOOK_ENGINE_VERSION` release.
-   Refined the Agents Server Documentation dropdown so only PERSONA, KNOWLEDGE, GOAL, TEAM, CLOSED, INITIAL MESSAGE, and USE SEARCH ENGINE stay at the top level while the remaining commitments live inside a hoverable ‚ÄúAll‚Äù submenu, keeping the menu compact on desktop and mobile.
-   Refined the experimental Story app in Agents Server: moved it to `/experiments/story` (with legacy `/story` redirect), changed story naming to use the editor‚Äôs first line instead of a separate title field, replaced the old `actors` model with selected existing server agents, switched Story export UI to a chat-save-style Save dropdown, and nested navigation under `System -> Experiments -> Story` using the existing hover submenu pattern.

-   Added a scroll-to-bottom indicator to the Agents Server chat so the floating arrow now announces unseen replies, surfaces a new-messages badge, and keeps the action accessible even when the user scrolls away from the newest content.
-   Refined the Agents Server chat scroll-to-bottom control with a cleaner directional arrow icon and richer frosted styling (hover/focus ring, subtle motion, and badge polish) while keeping sizing and color tokens DRY through shared CSS variables.
-   Improved Agents Server chat scroll indicator UX by showing the scroll-down control only while the latest message is actually out of view (not just based on autoscroll state), and redesigned the "X new messages" badge into a centered floating pill above the arrow for clearer placement and readability.
-   Removed `backdrop-filter` from the Agents Server chat scroll-down button and its new-messages badge so transformed overlay layers no longer create ghost blur patches above the message input.

-   Removed the Agents Server desktop hamburger menu so the toggle only appears in mobile layouts where it is used.
-   Improved the Agents Server transition from agent profile chat to full chat by removing the blocking overlay, fixing promise-safe message handoff from the profile composer/quick buttons, and using a shared view-transition surface so opening `/chat` feels immediate and seamless.
-   Fixed profile chat handoff so `?message=‚Ä¶` now always lands in a newly created chat and immediately runs the written or quick message even when the history loader has to bootstrap another chat ID, preventing the first conversation from opening blank after the chat history rewrite.
-   Added quick-access buttons to the profile chat preview so authenticated users can continue a recent conversation while the default action still starts a new chat.
-   Added a shared `SoundSystemProvider` and moved the chat sound/vibration toggles into the new header Control Panel (desktop dropdown + mobile card), keeping the global controls near the profile menu instead of buried under the chat save menu.
-   Added the shared useUnsavedChangesGuard hook so modal closing (starting with the Agents Server create-agent dialog) confirms before discarding agent book edits and blocks tab closes until the user confirms.
-   Removed the clone button from the Agents Server directory listing cards so cloning stays available only via the agent context menu, preventing duplicate actions in both views.
-   Modernized the Agents Server default agent visuals: the default avatar prompt now asks for a cinematic, digital portrait, the icon and screenshot generators share a DRY helper for gradient-forward layouts, and the image gallery page renders in a polished card-based design that keeps the new assets front and center.
-   Refined the Agents Server default avatar prompt to generate warmer, mentor-like animated agent portraits with stronger per-agent visual distinction, business-friendly tone, color-aware styling, and explicit no-text/no-photorealism constraints.
-   Added inline metadata editing to the Agents Server admin screen so values and notes can be updated directly from each row without scrolling to the add form.
-   Fixed Agents Server metadata row editing so clicking `Edit` opens only the selected row (including default keys) by tracking edit state per metadata key instead of shared default IDs, keeping edits in place without unexpectedly expanding all default entries.
-   Fixed Agents Server inline metadata typing focus loss by moving the shared metadata value editor to a stable module-level component (instead of recreating it during each render), so the cursor now stays focused while editing values in place.
-   Ensured the agent model requirements that are sent to third-party LLMs (and the Agents Server `/api/model-requirements` response) only include low-level properties by stripping `metadata`, `notes`, `parentAgentUrl`, and `promptSuffix`, keeping internal commitments data inside Promptbook.
-   Ensured the OpenAI compatibility chat endpoints in the Agents Server forward any `response_format` payload to the underlying OpenAI/API provider by mapping it to AgentKit output types before each run so JSON schema responses are honored.
-   OpenAI compatibility mode of the agent server now respects the `response_format` parameter by correctly passing it to the AgentKit execution tools.
-   Ensured `response_format` overrides still honor JSON schema output when cached AgentKit assistants are reused by mapping the format inside `AgentLlmExecutionTools` before running the prepared agent.
-   Supported the OpenAI `tools` and `tool_choice` parameters in the Agents Server compatibility proxy so requests that rely on function/tool calling are simply forwarded to OpenAI without needing Promptbook to implement the tooling itself.
-   Fixed the Agents Server clone flow so it now prompts with a prefilled "Copy of {agent name}" name, reuses a shared dialog helper, and redirects into the freshly cloned agent instead of a missing route.
-   Fixed the Agents Server home list so the client cache re-syncs with the server-provided agent and folder data immediately after signing in, eliminating the need for a manual refresh.
-   Added explicit drag handles to the Agents Server homepage cards so touchscreens can scroll freely while drag-and-drop remains pinned to a clearly marked handle that also works for folders.
-   The error dialog when the chat fails ("Connection Issue") now has an option to reset the chat with the same message sent to a fresh chat.
-   Added the `CHAT_FAIL_MESSAGE` metadata so the Agents Server can replace the technical fallback string with a friendly failure copy, and wired the chat routes and AgentChat wrapper to read this value before passing it into `LlmChat`.
-   Ensured country flag emoji render with the OpenMoji color font across the Agents Server UI (including the chat) so flags no longer fall back to regional-indicator letters and now appear as recognizable country icons.
-   Voice dictation now honors the user's locale (Accept-Language -> speech recognition language) so Whisper stays in the speaker's language instead of forcing English, with the new language hint threaded through Agent chat, profile chat, and the voice test client.
-   Added a new metadata flag `IS_EXPERIMENTAL_VOICE_TTS_STT_ENABLED` (default `true`) so admins can disable the shared text-to-speech / speech-to-text stack separately from `IS_EXPERIMENTAL_VOICE_CALLING_ENABLED`; the profile API now returns both flags, RemoteAgent surfaces the speech availability, the Agents Server chat hides the microphone and playback controls when speech is off, and every speech endpoint (`/api/voice`, `/api/elevenlabs/tts`, `/api/openai/v1/audio/transcriptions`) returns `403` whenever TTS/STT has been frozen out.
-   Fixed Agents Server chat attachments so the uploaded file metadata is forwarded to the agent prompt, keeping uploads accessible to the agent after hitting the server.
-   Fixed Agents Server chat uploads so attached files now use the shared CDN uploader and are stored on the server before the agent logs a message, preventing dropped attachments.
-   Hardened Agents Server chat attachment delivery end-to-end: chat now normalizes attachment payloads, appends a model-visible attachment URL section to the user prompt, uses short upload links for chat attachments, and makes `/api/upload` payload parsing/MIME handling resilient so valid files are no longer rejected by brittle client metadata.
-   Enabled Agents Server chat attachments to be ingested as temporary knowledge sources so each uploaded file is downloaded, indexed, and readable by the AgentKit agent (attachment-only runs skip the cached knowledge base to keep the vector store fresh while non-attachment flows still benefit from caching).
-   Added the `IS_FILE_ATTACHEMENTS_ENABLED` metadata flag (default `true`) so admins can toggle chat attachments off; when disabled, the Agents Server chat stops wiring the upload handler and hides the drag-and-drop/file button controls.
-   Show error message when the agent returns an empty message.
-   Enabled `\\(...\\)` and `\\[...\\]` LaTeX delimiters in chat markdown so inline and block formulas render with the existing KaTeX pipeline, matching `$...$`/`$$...$$` behavior and keeping the shared renderer reusable across chat/agent components.
-   Stopped KaTeX from running inside inline/fenced code in Agents Server chat so LaTeX notation remains raw when it is intentionally shown as code while still rendering normally in prose or blockquote contexts.
-   Preserved file attachments when cloning prompts for OpenAI chat so playground uploads keep their `arrayBuffer` after the OpenAI 6.18.0 upgrade.
-   Re-styled Markdown headings inside chat bubbles as card-like sections that lean on the same shared heading tokens but now add gradient glass texture, a thicker accent border, high-fidelity glow lines, and deeper drop shadows so the headings mirror the richer Agents Server card language.
-   Tuned the new heading tokens so every Markdown heading grabs its border, shadow, and text colors from the chat bubble palette, letting the card-like headers glow softly and stay in sync with the shared Agents Server design language.
-   Underlined inline links inside Agents Server chat bubbles so URLs stay recognizable now that the heading tiles use card-style backgrounds.
-   Fixed Agents Server chat avatar/bubble spacing while the agent is still thinking or streaming by making the avatar image size follow the responsive avatar container; incomplete and completed message rows now keep the same visual gap on mobile.

-   Added `scripts/verify-prompts/verify-prompts.ts`, an interactive helper that lists top-level prompts, walks through every `[ ]` section, archives resolved files under `prompts/done`, and automatically appends the requested fix prompts when work is still pending; registered the helper as a new task in `.vscode/terminals.json`.

-   Added quick chat/source pills to the Agents Server so the chat header and agent source (book) editor stay in sync; admins can now jump directly between the conversation and knowledge editor without returning to the profile page.
-   Added ElevenLabs speech playback to the chat so every bubble can be read aloud via the new `/api/elevenlabs/tts` route (guarded by the client-version handshake), complete with play/pause controls, cached audio blobs, and env-configurable voice/model defaults plus the shared `ELEVEN_LABS_API_KEY`, `ELEVEN_LABS_VOICE_ID`, and `ELEVEN_LABS_MODEL_ID` settings.
-   Added the `textToSpeechText` helper so the Agents Server voice chat sanitizes Markdown, URLs, citations, and formatting before calling both the OpenAI TTS route and the ElevenLabs `/tts` endpoint, keeping spoken replies clean while reusing one DRY implementation.

### üìö Book

-   Added flexible agent referencing for FROM, IMPORT, and TEAM so you can write {Activation code agent}, @Superagent, agentId, or even {https://foo} instead of raw URLs; the agents server now resolves these tokens by searching local and federated agents through a shared resolver.

-   Added the shared `AgentReferenceResolver` option to the core engine (and the new `CreateAgentModelRequirementsOptions` type) so Sender, IMPORT, and TEAM references are rewritten before applying commitments, and wired the resolver through the Agents Server APIs and cache managers to keep assistant creation and metadata in sync while a regression test protects the hook.
-   Reworked inline `KNOWLEDGE` so inline text pieces are converted into temporary CDN files before being added to `AgentModelRequirements.knowledgeSources`, introduced the uploader hook behind `CreateAgentModelRequirementsOptions`, and passed the shared uploader through all Agents Server cache/handler paths so inline knowledge behaves exactly like referenced files in vector stores and execution while still falling back to data URLs when the uploader is not supplied.
-   Fixed Agents Server teammate chat chips for compact TEAM references (`{Agent}` / `@Agent`) by resolving TEAM capabilities through the shared agent reference resolver in the profile API, so teammate communication chips and modal conversations render again after the agent-referencing upgrade.

-   Leveraged Vibrations API in the chat to provide haptic feedback in sync with the sound system.
-   Added metadata keys `DEFAULT_IS_SOUNDS_ON` and `DEFAULT_IS_VIBRATION_ON` so admins can configure the default chat feedback state, and surfaced independent sound/haptic toggles in the save menu (`ChatSoundToggle` + `ChatVibrationToggle`) that respect those defaults while persisting the user's choice.
-   Reworked the save menu controls into the new `ChatSoundAndVibrationPanel`, keeping the two switches inside a single polished card with lucide icons and dense status badges so the sound and haptic toggles stay intuitive yet inconspicuous.
-   Allow to make agent public / private agent from its context menu on the Agent profile page / right click of the agent.
-   Organized the Agents dropdown menu in the Agents Server header by folders: folders now link to their scoped homepage view, agents are indented under their folder hierarchy, and ordering follows the saved folder/agent sort order.
-   Made the Agents dropdown menu render folder branches in hover-expanding columns so large folder/agent trees stay manageable without overwhelming a single list.

-   Migrated Promptbook Agents to OpenAI AgentKit: added AgentKit execution tools with shared vector store handling, updated Agents Server caching to store AgentKit vector stores in `preparedExternals`, and refreshed playground samples.
-   Cached OpenAI vector stores in a new `AgentExternals` table keyed by knowledge source content hashes, removing `Agent.preparedExternals` from the Agents Server schema.
-   Added `note` metadata to Agents Server `AgentExternals` entries so cached vector stores record the creating agent and stored files.
-   Fixed OpenAI AgentKit knowledge ingestion by using the stable vector stores API and updated file batch calls for the current OpenAI SDK.
-   Removed invalid Keep-Alive request headers for OpenAI-compatible clients to fix AgentKit chat failures in Agents Server.
-   Replaced OpenAI assistant knowledge ingestion timing magic numbers with named constants to satisfy lint rules.
-   Reported word-based usage for OpenAI/OpenRouter compatibility chat completions in Agents Server, including native Promptbook usage details.
-   Fixed the Agents Server OpenAI compatibility handler so `usage.details` now includes real word/character/line/paragraph/page counts for both input and output by merging native usage with computed text statistics.
-   Wired Agents Server chat to reuse cached OpenAI Assistants (external preparation), building assistants from full model requirements and bumping the cache key version to avoid stale knowledge bases.
-   Added a script to batch delete OpenAI assistants with pagination and a confirmation prompt.
-   Fixed the OpenAI assistants cleanup script to auto-paginate through all pages before deletion.
-   Added a script to batch delete OpenAI assistants, vector stores, and files with a single confirmation prompt.

-   Added root nonce test files `nonce-foo-1.txt` and `nonce-bar-1.txt` for coding agent verification.
-   Regenerated the Agents Server Supabase subset schema for `Agent` and `AgentHistory` to stay aligned with the canonical database schema.
-   Regenerated the Agents Server Supabase schema types from migrations, aligning ChatHistory and File table fields.
-   Added Agents Server folder organization with nested folders, drag-and-drop ordering, URL folder paths, and recycle bin support for folders.
-   Fixed Agents Server folder creation at the root level by querying `parentId` with null-aware filters to avoid bigint "null" errors.
-   Replaced blocking browser `alert`, `prompt`, and `confirm` calls in Agents Server with queued async dialogs rendered via a global provider.
-   Added a queued `showLoginDialog` helper and wired the header login controls into the same async dialog queue so the login pop-up now uses the shared non-blocking modal shell and respects cancelation/ordering rules.
-   Refined the agent avatar hover tooltip in Agents Server chat with a cleaner card, profile link, and resilient image fallback.
-   Fixed agent avatar resolution to prefer META IMAGE across chat popups and UI cards, with consistent placeholder fallbacks for local and federated agents.
-   Added a global route loading indicator in Agents Server to show feedback during link navigation.
-   Enhanced refactor-candidate prompt generation with richer guidance, clearer file linking, and reason-aware context.
-   Added shared prompt emoji tag selection so generated refactor and boilerplate prompts use fresh unique `[‚ú®]` tags across the repo.
-   Added a refactor-candidate scanner script that flags oversized or entity-heavy source files and generates per-file refactor prompts in `prompts`.
-   Scoped the refactor-candidate scanner to `.ts/.tsx/.js/.jsx` files while skipping hidden directories, `node_modules`, and `packages/`.
-   Leveraged `spaceTrim` across the repository for better readability and maintainability of multiline strings and string joins.
-   Simplified the Agents Server home page to focus on agents, moved the previous dashboard to `/dashboard`, and linked it from the System menu.
-   Made Agents Server home list cards more compact and file-like, including smaller capability chips.
-   Enhanced Agents Server home agent cards with dynamic, color-based backgrounds and subtle noise effects for a more professional look.
-   Improved Agents Server list drag-and-drop with live reordering, drag overlays, and clearer drop targets for agents and folders.
-   Reduced accidental drag activations on touchscreens in the Agents Server home list by adding touch-specific activation delays.
-   Added a parent folder card in Agents Server list view to quickly navigate up and drag agents or folders to the parent.
-   Created new agents inside the active folder when adding from a subfolder view in the Agents Server home list.
-   Added a configurable Markdown message (via metadata) shown above the agents list on the Agents Server homepage.
-   Added `AGENT_NAMING` metadata to customize agent terminology (singular/plural) across the Agents Server UI with casing-aware replacements.
-   Added `THINKING_MESSAGES` metadata so admins can set slash-delimited placeholder variants (default `Thinking... / Searching for information... / Sorting information...`) that rotate while an agent is composing a reply.
-   Agents Server chat now samples a random `THINKING_MESSAGES` variant each time an agent starts thinking and then switches to another random variant every 1-5 seconds until the agent finish streaming its reply, giving the thinking placeholder a lively, ever-changing feel.
-   Scoped the Agents Server homepage message and federated agents to the root view, and updated folder headings to show the folder name with per-folder agent counts.
-   Added a shared Agents Server context menu with right-click support on agent cards, plus rename actions reused on agent profile pages.
-   Added an "Open Folder" action to the Agents Server agent context menu (profile menu and right click) to jump to the agent's folder for management.
-   Added a chat preparation chip in Agents Server to signal when GPT assistants are being created before the first response.
-   Added `[ü§∞]`-tagged assistant preparation logging (cache lookup, model requirement timing, assistant create/update, vector store progress) and surfaced preparation phases on the "Preparing agent" chip.
-   Added per-knowledge-source download timeouts plus richer logging during OpenAI assistant knowledge ingestion to pinpoint stalls.
-   Added detailed OpenAI vector store upload progress logs (file uploads, batch polling, timeouts) to prevent assistant preparation from hanging silently.
-   Added vector store batch diagnostics (file type summary, per-file status samples, vector store status) and guarded invalid batch IDs during assistant knowledge ingestion.
-   Fixed OpenAI vector store batch polling to log expected vs. returned batch IDs and cancel using the created batch ID when mismatches occur.
-   Fixed vector store file batch polling to use real batch IDs (vsfb\_\*) and improved diagnostics to map uploaded file IDs to vector store file IDs.
-   Scoped the "Preparing agent: Creating assistant" chip in Agents Server to cache misses by emitting it only when a new assistant is created from cache lookup.
-   Enhanced OpenAI vector store upload robustness and logging:
    -   Added explicit file extension logging during knowledge ingestion to identify potential bottlenecks.
    -   Implemented early "stalled" diagnostics if vector store batches remain in progress for more than 30 seconds without change.
    -   Added specific warnings for PDF files which are known to cause ingestion delays.
    -   Synced comprehensive polling and diagnostic logic between Assistants and Responses APIs.
-   Added `shouldContinueOnVectorStoreStall` option to OpenAI assistant tools (default `true`) to prevent stuck PDF ingestion from blocking agent preparation.
-   Fixed Vector Store ID vs. File Batch ID mismatch handling in OpenAI polling logic.
-   Fixed Agents Server chat to always return a fallback message when the model produces an empty response, including streaming and OpenAI-compatible endpoints.
-   Fixed Agents Server Book editor multi-file uploads by debouncing editor updates, tracking placeholders safely, and adding a floating upload panel with pause/resume controls and upload stats.
-   Fixed federated agent item design on home page to match local agents.
-   Fix federated agent images by correctly resolving placeholder URLs from the originating server.
-   Fixed Agents Server chat markdown rendering for sublists by normalizing unordered list indentation under ordered items.
-   Deduplicated Agents Server chat source chips so repeated document sources show only once per message.
-   Deduplicated tool call chips in Agents Server chat by stabilizing tool call identities across partial updates.
-   Fixed duplicated tool call chips (blank/filled pair) by deduplicating repeated tool call entries and rendering only the final, result-rich chip for each tool invocation.
-   Grouped identical ongoing tool call chips in Agents Server chat so concurrent tool runs collapse into a single chip with a count.
-   Fixed grouped ongoing teammate chips so tool calls from different teammates no longer collapse into one chip, while repeated calls from the same teammate still aggregate with a count.
-   Added tactile feedback for Agents Server chat tool call chips and streaming responses by routing the chat sound system into chip rendering and vibrating on every streaming chunk, so tool usage and in-progress replies feel more immersive.
-   Redesigned the Agents Server memory tool call modal so memory chips now show a friendly hero header, status badge, and scoped memory cards (query, match count, global/personal scope) instead of raw JSON blobs, making saved/loaded memories easier to understand.
-   Fixed drag-and-drop uploads in the Agents Server create-agent dialog by reusing the shared BookEditor upload handler.
-   Fixed document source citation in Agents Server chat:
    -   Resolved issue where clicking on KNOWLEDGE source chips showed "Document preview unavailable" instead of the actual document
    -   Fixed `/api/profile` endpoint to explicitly include `knowledgeSources` array in the response
    -   Added inheritance support for `knowledgeSources` so child agents inherit knowledge from parent agents
    -   Citations from KNOWLEDGE commitments now correctly resolve to their source URLs for preview and download
    -   Follows DRY principle - parsing logic is centralized in `parseAgentSource()`, data flows through API to `RemoteAgent`
-   Allowed Agents Server chat source chips to cite non-document sources: simple URLs now render inside the citation modal iframe (with the friendly label derived from the URL) and inline text snippets show their first 30 characters in the chip while the modal renders the full Markdown excerpt, all without disrupting the existing knowledge-document preview flow.
-   Fixed Agents Server image generation and uploads to safely shorten CDN paths for long filenames, preventing Vercel Blob path length errors.
-   Added support for inline `![alt](?image-prompt=...)` markers coming from agents that use `USE IMAGE GENERATOR`: the chat now parses the notation, reuses the shared `constructImageFilename` helper, queues `/api/images` with the same lock/queue logic, displays a spinner-based placeholder, and swaps in the CDN-hosted image once it finishes rendering.
-   Normalized file names before uploads in Agents Server (chat attachments, knowledge uploads, admin file uploads) to keep CDN URLs clean and consistent.
-   Added actions to image gallery in Agent's Server:
    -   Copy image prompts to clipboard
    -   Display technical parameters (model, size, quality, style) extracted from filenames
-   Allow to add image in the image prompt in `ImageGeneratorTestClient`
-   Ensured the Agents Server chat menu stays above chat action buttons (New chat, Save, etc.).
-   Added top spacing in Agents Server chat so action buttons no longer overlap the first messages.
-   Faded Agents Server chat action buttons while scrolling when they overlap the first visible message.
-   Kept Agents Server chat action buttons softly faded when they still overlap messages after scrolling, while restoring clickability once scrolling stops.
-   Updated the Agents Server self-learning chip to use the brain icon without brackets.
-   Enhanced the Agents Server self-learning modal with a friendly summary and server-provided learning details.
-   Updated the Agents Server self-learning modal to show agent + teacher avatars and render learned commitments in a read-only BookEditor.
-   Added per-message timestamps in Agents Server chat with agent generation durations, and included timestamps in exported chat files.
-   Fixed Agents Server chat avatar spacing while responses stream so in-progress bubbles align with completed messages.
-   Added Promptbook SDK integration snippets in Agents Server, including RemoteAgent Node.js and React examples on the integration page.
-   Added API key field to the OpenRouter integration section in Agents Server to match OpenAI compatible setup.
-   Added a Create API Key action on the agent integration page so admins can generate tokens without leaving the integrations screen.
-   Fixed Rollup publishing config to inline dynamic imports so package builds no longer fail on multi-chunk outputs in CI.
-   Redesigned the Agents Server home graph with Beautiful Mermaid diagrams while keeping server clustering, filtering, federated links, and avatar labels.
-   Refined the Agents Server home agents graph to a social-style relationship map with softer nodes, avatar rings, and curved, color-coded links.
-   Improved Agents Server graph filtering so focused agents include directly connected neighbors across local and federated servers.
-   Enhanced the Agents Server agents graph with category-based node shapes, status colors, and roomier layout spacing for cleaner clusters.
-   Updated Agents Server home graph nodes to render agent-brand chips with avatars, brand-based fills, and readable text.
-   Added Agents Server home graph download buttons for PNG, SVG, and ASCII exports powered by Beautiful Mermaid.
-   Redesigned the Agents Server home graph with React Flow, adding draggable layout edits, server/folder grouping, and responsive graph interactions.

-   Enhanced prompt template literal handling to return `PromptString`, inline safe parameters, and append structured parameter/context blocks for unsafe or multiline data with escaping.
-   Added prompt notation documentation, examples, and a live evaluator to the Utils app.
-   Enhanced prompt notation example actions in the Utils app with an overwrite warning, clipboard copy, and download shortcuts.
-   Replaced prompt notation example action emojis with Lucide icons in the Utils app.
-   Added install instructions and import header to prompt notation example downloads in the Utils app.
-   Generated prompt notation example outputs dynamically on render in the Utils app to keep outputs in sync with the prompt notation implementation.
-   Updated prompt notation output to use numeric parameter placeholders and a numbered parameters list.
-   Switched prompt notation parameter placeholders to alternate labels when bracketed numbers appear in user input to avoid collisions.
-   Render structured JSON parameters without double-escaping in prompt notation outputs.
-   Enhanced `humanizeAiText` to normalize more dash, quote, ellipsis, and whitespace variants in AI text.
-   Removed bracketed source citation artifacts (e.g. `\u30105:1\u2020source\u3011`) from `humanizeAiText` output.

-   Improved error reporting in package generation script to show the actual line where markers ([üü¢], [‚ö™], [‚ö´], [üü°], [üîµ]) are found when they shouldn't be published in packages. This helps developers quickly identify and fix issues by displaying the line number and content instead of just the filename.
-   Enhanced all comparison documents in `/documents/comparison/*.md` for better balance and clarity:
    -   Balanced pros/cons tables: Added legitimate advantages to alternative platforms (Agno, ChatGPT, Claude, etc.) and acknowledged Promptbook's limitations for fair comparison
    -   Expanded "Best for" sections: Both Promptbook and alternative platforms now have detailed use case descriptions
    -   Improved objectivity: Each platform's strengths are now accurately represented, maintaining overall balanced perspective while highlighting Promptbook's unique advantages in federated architecture, commitment system, and cross-platform portability
-   Implemented `TEMPLATE` commitment to enforce specific message structure or response templates for agent responses.
-   Added nonce test files at the repository root for coding agent verification.
-   Added a script to run prompt files through OpenAI Codex with prompt status tracking and git commits.
-   Added support for Gemini CLI to the coding agent script with the `--agent gemini` flag, allowing non-interactive prompt execution and automated git commits.
-   Added interactive waits between codex prompt tasks with a `--no-wait` override flag.
-   Added `--ignore-git-changes` flag to the coding agent runner to skip the clean working tree check.
-   Added per-prompt start summaries with a confirmation wait before each prompt runs (unless `--no-wait`).
-   Estimated OpenAI Codex runner prices from Codex CLI token counts instead of reporting $0.00.
-   Improved Codex pricing for the coding agent by parsing the CLI token breakdown, calculating prompt/completion costs per model (including `gpt-5.1-codex-mini`), and marking fallback estimates as uncertain so the reported ~$0.30 matches real usage.
-   Added coding runner and model signatures to coding agent prompt status lines.
-   Implemented `USE IMAGE GENERATOR` commitment to allow agents to generate images using an image generation model.
-   [‚ú®‚õ™Ô∏è] Allow to close dialogs by clicking outside of the dialog.
-   Created a series of comprehensive comparison documents between Promptbook and other projects (ChatGPT, Claude, ChatGPT-Assistance, LangChain, N8N, NotebookLM, Wordware, Agno, Letta, Eliza, and Digital Twin platforms like Personal.ai/Delphi) in `/documents/comparison/*.md`. These comparisons highlight Promptbook's unique "Book" language, commitment system (Persona, Knowledge, Rule, Team), and its federated, open-source architecture.
-   Implemented `IMPORT` commitment that allows to import generic text files (both local and URL) into the agent source with plugin-based architecture.
-   Created file named `nonce-foo-4.txt` with content `foo`
-   Created file named `nonce-bar-4.txt` with content `bar`
-   Created file named `nonce-foo-3.txt` with content of of output of `date +%s`
-   Created file named `nonce-bar-3.txt` with content of output of `ls -la`
-   Created nonce test files `nonce-foo-1.txt`, `nonce-bar-1.txt`, `nonce-foo-2.txt`, and `nonce-bar-2.txt` at the root of the project to verify coding agent functionality.
-   Implemented GitHub import script that fetches issues and discussions from a Promptbook repository and structures them into Markdown files.
-   Code blocks in the book are assigned to the commitment where they are placed.
-   Allow to attach files to the chat messages in Agents Server [2025-12-0900-agents-server-chat-attachements.md](https://github.com/webgptorg/promptbook/blob/main/prompts/2025-12-0900-agents-server-chat-attachements.md)
-   Implement Ctrl+S shortcut in `<BookEditor/>` component
-   Implement Ctrl+V shortcut in `<BookEditor/>` component for pasting images and files
-   Implement Ctrl+S shortcut in `<Chat/>` component for opening export menu
-   Refactored the `<Chat/>` component into smaller, single-responsibility modules to improve readability and maintainability.
-   Implement tool calling loop into the `LlmExecutionTools`. Currently only for `OpenAiCompatibleExecutionTools`
-   Show floating hint when creating new agent in Agents Server [2025-12-0920-agents-server-hints.md](https://github.com/webgptorg/promptbook/blob/main/prompts/2025-12-0920-agents-server-hints.md)
-   Agents Server can generate boilerplate rules and personas in the same language as the agent name [2025-12-0950-agents-server-boilerplate-rules-and-personas-in-language-of-server.md](https://github.com/webgptorg/promptbook/blob/main/prompts/2025-12-0950-agents-server-boilerplate-rules-and-personas-in-language-of-server.md)
-   Record all tool calls and aggregate usage in `promptResult` when the tool calling loop is used.
-   Improved the design of the agent server name in the header to prevent wrapping on long names
-   Samples of communication (USER MESSAGE and AGENT MESSAGE) are now transferred into the system message.
-   The initial message is now also included in the example interaction within the system message and is passed into the samples with `question` set to `null`.
-   Horizontal lines (`---`) are now filtered out from the system message.
-   Use Teacher Agent for self-learning of the agents.
-   Self-learning is now a two-step process: first appending conversation samples, then asynchronously calling the Teacher Agent.
-   Added `TEACHER` well-known agent to the core server configuration.
-   Fixed syntax highlighting for `LANGUAGES` and `RULES` in the book editor to ensure the whole word is highlighted, preferring long forms over short forms
-   Implemented `USE TIME` commitment to add the ability for agents to determine the current date and time.
-   Added timezone awareness to `USE TIME` commitment.
-   Added extra instructions to the system message for `USE TIME`, `USE SEARCH ENGINE`, and `USE BROWSER` commitments to provide explicit guidance for the agent on when and how to use these tools.
-   Allow optional instructions after `USE SEARCH ENGINE` and `USE TIME` to be included in the system message.
-   Implemented `USE SEARCH` (and `USE SEARCH ENGINE`) commitment that adds the ability for agents to perform web search using `SerpSearchEngine`.
-   Implemented `SerpSearchEngine` that uses the SerpApi to fetch Google search results.
-   Implemented `GoogleSearchEngine` that uses Google Custom Search JSON API to fetch results.
-   Defined tools in OpenAI Assistant when creating or updating it through `AgentLlmExecutionTools`.
-   Books can contain Markdown code blocks, which are treated as raw text and not parsed for commitments
-   Code blocks in the `<BookEditor />` are distinctly highlighted
-   Do the full proxy of the given LLM tools in `countUsage` and `cacheLlmTools`
-   Show linked Agents on Agent profile via the capability chips
-   Implemented `TEAM` commitment with teammate tool calling, chiplets/modals, and team connections in agent profiles and the agents graph
-   Fixed TEAM commitment tool execution to resolve teammate tool functions dynamically and use `RemoteAgent` for teammate calls.
-   Implement Ctrl+V shortcut in `<Chat/>` component for pasting images and files
-   Agents social graph on home page
    -   Handle agent profile image loading failures gracefully by showing initials fallback
    -   Limit image loading retries to 3 attempts with exponential backoff
    -   Show agents as nodes in an interactive graph view
    -   Visualize connections via inheritance (`FROM`) and `IMPORT`
    -   Support for zooming, panning, and dragging nodes
    -   Filter connection types and focus on specific agents
    -   Persist view and filters in URL query parameters
    -   Show agents from federated servers in the graph
    -   Each federated server is represented as a color-coded cluster
    -   Visualize cross-server links between agents
    -   Advanced filtering by server and specific agents within servers
    -   Federated agents are loaded independently and shown in clusters in the graph view.
    -   Added loading and error indicators for federated servers in the graph and filter dropdown.
    -   Show tool call indicator (spinner + tool name) during LLM execution in `<Chat/>` component
    -   Make the Agents Graph visually more appealing [1]
        -   The arrow should be at the end of the edge showing the direction of the link
        -   The chip with the agent should be visually more appealing, Use image and color of the agent in a nice looking circle.
            -   In the agent graph, each agent should have its own profile picture in the circle.
            -   The color should be preserved but only as a background, not the full picture.
            -   In The tooltip shows the agent description. Do not replicate the agent name.
        -   The Group around federated agent server should be circle, not square.
        -   Also, the group around federated servers should not overlap. It should be separate, distinct clusters. Connection between the agents can go across the federated server group boundary.
        -   Fixed and improved agent graph relations:
            -   Show directional graph arrows and moving particles to indicate connection direction
            -   Corrected URL normalization for inheritance (`FROM`) and `IMPORT` links to ensure agents are correctly connected (e.g., matching Sophia Green and Sophia Supergreen)
            -   Ensure connections correctly respect user preferences in checkboxes
-   Added `linguisticHash` utility function to `@promptbook/utils` that creates human-readable hashes.
-   Added `Linguistic Hash` tool to the Utils app.
-   Enhanced `linguisticHash` to return a short story-like sentence for more memorable hashes, updating the Utils app text and unit tests to match.
-   Added configurable word counts (1-20, default 7) to `linguisticHash`, including Utils app controls, warnings for short hashes, and updated tests.
-   Added multilingual support to `linguisticHash` with Czech word lists and a language selector in the Utils app.
-   Refactored `linguisticHash` internals to split word selection and word count helpers into focused modules for easier maintenance.
-   Prevent caching when tool is used, but still write the messages into the cache or `USER MESSAGE` + `AGENT MESSAGE` pair
-   Implemented modular voice speech input in `<Chat/>` with two providers: `BrowserSpeechRecognition` (Web Speech API) and `OpenAiSpeechRecognition` (Whisper API).
-   Added voice input test page at `/admin/voice-input-test` in Agents Server.
-   Added microphone button to `<Chat/>` with visual recording indicators and real-time transcription insertion.
-   Enhanced visuals of the agent chat page
-   Refined chat message bubble sizing with a minimum width and responsive max widths for desktop and mobile layouts.
-   Increased the minimum chat bubble width on small screens so short messages no longer render as tiny pills in Agents Server chat.
-   Fixed chat message stack width so source chips wrap within bubble bounds on desktop and mobile in Agents Server.
-   Added grained background to the chat page (matching the agent profile page)
-   Increased saturation of agent messages for better visibility
-   Fixed chat page height to exactly 100vh to prevent unnecessary scrolling
-   Recursive inheritance for meta properties (e.g. `META COLOR`) in `Agents Server`
-   Enhanced the visual design of the chat input area with a modern capsule-like design, better padding, refined button styling, and brand-color focus highlights.
-   Human-readable titles for showing tool calls in chiplets with better labels and emojis (e.g. `[üîé Venezuela]`).
-   Clicking on a tool call chiplet opens a modal with tool call details (arguments and results).
-   Improved tool call details modal with better formatting for arguments and results (especially for search results).
-   Reimagined the generic tool call modal (used by non-special chips) with a hero header, prose-rich request/result panels, friendly issue badges, and a collapsible raw payload view so it feels intuitive for everyone while retaining the raw JSON for explorers.
-   Web Search: Show stored tool results in the source chiplet modal in Agents Server (parsed list or raw output).
-   Store raw tool call data (arguments/results/errors/timestamps) in `ChatMessage.toolCalls` and render time/search chiplets from stored tool calls (no re-runs).
-   Improved search results parsing in tool call modal to handle multiple nested result formats (stringified JSON, nested result objects, various field names like `data`, `items`, `results`)
-   Record timestamp of tool calls and store them in `ChatMessage.completedToolCalls`
-   Preserve assistant message content in Agents Server chat when tool calls are emitted.
-   When the `USE TIME` is used, show the chiplet which will show that time was used (similarly to `USE SEARCH ENGINE` chiplets).
-   User-friendly details popup for the time tool with a visual clock and relative time display based on the tool call timestamp.
-   Allow AI to leverage all the options and possibilities of SERP search engine (location, localization, pagination, advanced filters, etc.).
-   Updated `SearchEngine` interface to support advanced options.
-   Enhanced Search Engine Test page with advanced SERP parameters and raw call details.
-   Allow to add additional model requirements like image size in the [Image Generator Test](http://localhost:4440/admin/image-generator-test)
-   Improved the voice input in the chat component to be more natural:
    -   Implemented silence detection (VAD-like) in `OpenAiSpeechRecognition` using `AudioContext` and `AnalyserNode` to automatically stop recording after 2 seconds of silence.
    -   Show better visual feedback that the audio is being processed.
    -   Once transcription is done, automatically insert the transcribed text into the chat input box.
    -   Cleaned up redundant logic in `<Chat/>` component regarding voice input handling.
-   Enhance visuals of the agent connections on the Agents Graph on home page
    -   Increase distance between nodes in the graph
    -   Remove particle animation from connection links
    -   Improve connection arrow visibility
    -   Enhanced visuals with smoother node hover effects, shadowed nodes, and oceanic cluster backgrounds
-   Added a home page Agents Graph overview panel that shows the number of visible agents and servers, connection totals, folder-order links, and per-type counts so filtering feedback is immediate.
-   Removed `isOpen` prop from dialogs in Agents Server and implemented conditional rendering to prevent unnecessary background rendering when closed.
-   Added "Back to Agent" button to all agent-specific pages in Agents Server for better navigation.
-   Allow to pass `files` as `Array<File>` into `ChatPrompt`.
-   Implement file passing in `OpenAiExecutionTools` (currently supporting images via `image_url`).
-   Implemented `ChatPrompt.files` for `OpenAiAssistantExecutionTools`, allowing to attach files to OpenAI Assistants via the message attachments.
-   Add sample of passing files in OpenAI playground.
-   Support for generating images in Google LLM execution tools.
-   Fixed Google image generation in Agents Server to call the Gemini API directly when using Vercel providers.
-   Implemented tool calling when transpiling book into the code in `OpenAiSdkTranspiler`.
-   Added ESLint rule `no-magic-numbers` to the entire project (root and `agents-server`), configured to allow common semantically distinct numbers like -1, 0, 1, 2, 10, 60, 100, 1000.
-   Added prompt prioritization to the Codex prompt runner, honoring `[ ] !`, `[ ] !!`, `[ ] !!!` and grouping upcoming tasks by priority.
-   Filtered Codex prompt runner upcoming tasks to exclude prompts that still need authoring (`@@@`).
-   Added Cline CLI as a second agent runner in the coding agent script with `--agent <openai-codex|cline>` flag.
-   Added Claude code as a third agent runner in the coding agent script with `--agent <openai-codex|cline|claude-code>` flag.
-   Standardized runners of coding agent script to use temporary script files for robust prompt execution.
-   Reorganized the coding agent prompt runner script into runner-specific folders and shared utilities without behavior changes.
-   Implemented interactive chat animations triggered by emojis in agent messages:
    -   Added `ChatEffectsSystem` component with pluggable architecture for visual effects
    -   Implemented confetti animation effect for üéâ emoji (particles falling from top)
    -   Implemented floating hearts animation effect for ‚ù§Ô∏è and other heart emojis (hearts rising from bottom)
    -   Effects trigger only once per message even with multiple identical emojis
    -   Multiple different emojis in the same message trigger multiple effects simultaneously
    -   Effects only trigger for newly received agent messages (not user messages, not old messages on scroll)
    -   Decoupled effects logic with separate components for each effect type
    -   Easily extensible system for adding new effects in the future
    -   Integrated into all chat components: `<Chat/>`, `<LlmChat/>`, `<AgentChat/>`, `<MockedChat/>`
    -   Default effects configuration enabled in Agents Server chat interface
-   Implemented chat sound system with gentle, non-annoying audio feedback:
    -   Created `SoundSystem` class for managing chat sounds with localStorage persistence
    -   Implemented `ChatSoundSystem` interface for decoupled sound integration
    -   Added sound effects for message events:
        -   Subtle "whoosh" sound when user sends a message
        -   Soft "ding" sound when agent sends a message
        -   Light typing indicator sound when agent is thinking
    -   Added sound effects for button interactions (tap sound on all clickable buttons)
    -   Added sound effects for emoji-triggered visual effects:
        -   Celebratory sound for confetti effect (üéâ)
        -   Gentle sound for hearts effect (‚ù§Ô∏è)
    -   Implemented sound settings toggle in the save menu (üîä/üîá) with localStorage persistence
    -   All sounds are:
        -   Gentle and professional (not jarring or annoying)
        -   Short duration (< 2 seconds)
        -   Configurable volume levels
        -   Can be muted by user
    -   Sound system is:
        -   Decoupled from Chat component (passed as prop)
        -   Scalable for future sound effects
        -   Follows best practices with separation of concerns
        -   Pluggable to all Chat implementations (`<Chat/>`, `<LlmChat/>`, `<AgentChat/>`, `<MockedChat/>`)
    -   Sound assets directory created at `apps/agents-server/public/sounds/` with documentation for required audio files
    -   Integrated into Agents Server via `AgentChatWrapper`
-   Enhanced `USE BROWSER` commitment with two-level browser access:
    -   Implemented `fetch_url_content` tool for one-shot URL content fetching and scraping
    -   Prepared `run_browser` tool for future complex browser interactions (scrolling, clicking, form filling)
    -   Agent can now fetch and scrape content from URLs including webpages and documents
    -   Integrated with existing scraper system (`WebsiteScraper`, `PdfScraper`)
    -   Added `fetchUrlContent` utility function to handle URL fetching and content conversion to markdown
    -   Updated tool titles and descriptions to distinguish between one-shot and running browser modes
    -   Tool functions properly integrated into commitment system via `getToolFunctions()`
    -   **Refactored for browser safety:**
        -   Created `/api/scrape` endpoint in Agents Server to proxy server-side scraping functionality
        -   Implemented `fetchUrlContentViaBrowser` wrapper that safely calls the API from browser environments
        -   Updated `USE_BROWSER` commitment to automatically detect environment and use appropriate implementation:
            -   Server-side (Node.js): Direct scraping via `fetchUrlContent`
            -   Browser: Proxy through Agents Server API via `fetchUrlContentViaBrowser`
        -   Added environment detection using `$isRunningInBrowser()` utility
        -   Prevents server-only code (marked with [üü¢]) from being executed in browser packages
-   Implemented `USE EMAIL` commitment to enable agents to send emails:
    -   Created `UseEmailCommitmentDefinition` with support for optional additional instructions (e.g., "Write always formal and polite emails")
    -   Implemented `send_email` tool that integrates with the existing email queue system in Agents Server
    -   Tool supports sending emails with multiple recipients, CC, subject, and markdown-formatted body
    -   Added email capability chip to agent profiles showing "Email" with a mail icon
    -   Implemented email chiplet display showing the email subject when the tool is used
    -   Created interactive email details popup modal with Gmail-like UI showing:
        -   Email metadata (To, CC, Subject) in a styled header
        -   Full email body rendered as markdown in a clean, readable layout
        -   Tool call result showing success/failure status
    -   Email tool leverages existing `sendMessage` utility and email providers (Sendgrid, Zeptomail)
    -   All emails are queued through the database-driven message system
    -   Follows the same pattern as `USE TIME` and `USE SEARCH ENGINE` commitments for consistency
-   Implemented a new experimental app called **Story**, an interactive storytelling app where users orchestrate AI agents to collaboratively write a story.
    -   Added a new top-level menu group: **Experiments**, visible only when the `IS_EXPERIMENTAL_APP` metadata flag is enabled.
    -   The app supports two modes: **Beletrie Mode** (free narrative) and **Dramatic Mode** (dialogue).
    -   Users can manage multiple stories with a bookmarks/chapters-style UI.
    -   Stories are persisted per user across devices using a new extensible `UserData` table.
    -   Stories can be exported to plain text and Markdown, with a clear **Experimental** label.
-   Fixed `USE EMAIL` tool exposure to use commitment-provided functions with node/browser variants and updated the email tool modal to display sender metadata and status.
-   Enhanced agent-to-agent interaction chips in chat UI:
    -   Created reusable `<AgentChip/>` component displaying agent avatar and name
    -   Replaced generic "ü§ù Consulting teammate..." text with agent-specific chips showing actual agent profile picture and name
    -   Removed displaying agent IDs (e.g., "TEoiVpZzBgTPUi") in favor of user-friendly agent names
    -   Agent chips automatically fetch agent profile data from both local and federated servers
    -   For ongoing consultations, chips display spinner animation with agent avatar and name
    -   For completed consultations, chips are clickable and show full team interaction details
    -   Implemented DRY principle with single reusable chip component inspired by `<AgentProfile/>`
    -   Works seamlessly with both same-server and federated agent interactions
    -   Added `teammates` prop to `<Chat/>` and `<ChatMessageItem/>` components to pass agent metadata
    -   Updated `getToolCallChipletInfo()` to return agent data along with display text
    -   Enhanced `TeamToolResult` type to include teammate URL and label information
-   Fixed teammate consultation chips to resolve agent names and avatars from team metadata and tool results, avoiding agent IDs in both ongoing and completed tool calls.
-   Enhanced team consultation modal design and UI:
    -   Simplified modal to show only `<MockedChat/>` component with the conversation between agents
    -   Agent profile pictures and names are now displayed through the existing `participants` prop of `<MockedChat/>`
    -   Removed "Teammate:" and "When to consult:" sections from the modal for cleaner design
    -   Display agent names instead of agent IDs (works with both local and federated agents)
    -   Added clickable agent name header that opens the agent page in a new window
    -   Modal now focuses on the actual conversation, making it easier to understand agent interactions
-   Improved TEAM tool call modal UX with linked participant header badges, avatar/name labels in the conversation, and a top-right close button.
-   Surfaced transitive teammate tool calls and source chips in Agents Server chat with "by teammate" suffixes, and listed those tool calls with inline details inside the TEAM modal.
-   Enhanced caching of GPT assistants created for agents on Agents Server:
    -   Created `AssistantCacheManager` class to centralize assistant lifecycle management
    -   Implemented `computeAssistantCacheKey` utility to compute cache keys based on assistant configuration
    -   Added `extractAssistantConfiguration` function to separate base agent config from dynamic context
    -   Supports two caching modes:
        -   Strict caching (default): includes full configuration including dynamic CONTEXT in cache key
        -   Enhanced caching: excludes dynamic CONTEXT from cache key for better reuse across similar agents
    -   Improved code maintainability and DRY principle by consolidating duplicate caching logic
    -   Made the system extensible for future configuration parameters (model, temperature, tools)
    -   Added detailed logging for cache hits and misses with cache keys
    -   Refactored `handleChatCompletion` to use the new `AssistantCacheManager`
-   Appended an 8-character assistant cache hash to GPT assistant names in Agents Server for clearer differentiation (e.g. `My Agent - abcd1234`).
-   Enhanced error handling for agent chat in Agents Server:
    -   Created centralized error message mapping utility (`errorMessages.ts`) following DRY principle:
        -   Categorizes errors into user-friendly categories (network, authentication, validation, rate limit, server error, timeout, etc.)
        -   Provides context-aware friendly error messages instead of raw technical errors
        -   Logs raw errors to console.error for debugging while showing user-friendly messages in UI
    -   Implemented `<ChatErrorDialog/>` component with retry functionality:
        -   Displays user-friendly error titles and messages in a modal dialog
        -   Shows retry button for recoverable errors (network issues, timeouts, server errors)
        -   Allows dismissing errors with cancel/close buttons
        -   Modern, polished UI with error icons and action buttons
    -   Added error handling support in `<LlmChat/>` component:
        -   Introduced optional `onError` prop to handle errors with custom logic
        -   Stores last failed message for retry functionality
        -   Provides retry callback to allow re-sending failed messages
        -   Maintains backward compatibility (errors still shown in chat if no handler provided)
    -   Integrated error handling in `AgentChatWrapper`:
        -   Uses `handleChatError` utility to categorize and format errors
        -   Displays `<ChatErrorDialog/>` with retry button for failed messages
        -   Automatically retries last failed message when user clicks retry button
    -   Improved user experience:
        -   Clear, actionable error messages instead of technical jargon
        -   Ability to retry failed operations without re-typing messages
        -   Consistent error handling across all chat interfaces
        -   Better debugging with raw errors logged to console
-   Moved the back button to the top menu bar in agent-specific pages (chat, book, etc.) using the existing hoisting mechanism for a cleaner and more consistent UI.
-   Fixed Agents Server back button menu hoisting to avoid a render loop that triggered "Maximum update depth exceeded" warnings.
-   Reduced number of capability chips in Agents Server:
    -   Grouped identical Knowledgebase chips together.
    -   Hid the `VOID` inheritance chip, showing only inheritance from other agents.
-   Limited capability chips on Agents Server cards and profiles with priority ordering and grouped knowledge/PDF sources to reduce chip overload.
-   Enhanced RAG source citation display in Agents Server chat:
    -   Replaced ugly OpenAI annotation format `„Äê5:13‚Ä†document.pdf„Äë` with native Promptbook chips
    -   Created `<SourceChip/>` component displaying source document with file icon and citation ID
    -   Citations now appear as clickable chips below messages (similar to `USE SEARCH ENGINE` commitment)
    -   Implemented citation preview modal with:
        -   Source document name and citation ID
        -   Optional URL link to the source document
        -   Document excerpt/preview when available
        -   Clean, user-friendly UI matching existing tool call modals
    -   Added `citations` field to `ChatMessage` type for storing RAG source annotations
    -   Implemented `parseCitationsFromContent` utility to extract citations from message content
    -   Citation references in text are now rendered as numbered superscripts `[5:13]` instead of full annotations
    -   Follows DRY principle by reusing existing modal styles and chip patterns
    -   Integrated seamlessly with existing chat UI and tool call chip system
-   Enhanced document preview in Agents Server chat:
    -   Clicking on a `KNOWLEDGE` source chip now opens a document preview in an iframe (e.g. for PDFs).
    -   Added a "Download" button to the source preview modal.
    -   Automatically detects URLs in source names if explicit URL is missing.
    -   Improved fallback messaging when no preview is available.
    -   Moved close button to the top right corner with 'X' icon for better UX.
    -   Relaxed URL validation to allow previewing documents from relative paths or filenames.
    -   Ensured download button is available when source is present.
-   Added missing sound files to the Agents Server's public directory.
-   Enhanced the UI of the chips of `TEAM` commitment to show agent profile picture and name instead of ID in agent lists and profile pages.
-   Rendered chat chip emojis (tool calls and source citations) with the OpenMoji color font in Agents Server.
-   Migrate `Agent` class and all related classes from using OpenAI Assistants API to OpenAI Responses API.
    -   `KNOWLEDGE` works as before.
    -   Tool calling works as before.
    -   Caching of the agents and underlying assistants works as before.
    -   It works in the `Agents Server` application `/apps/agents-server`.
    -   All existing features work as before.
    -   Kept `OpenAiAssistantExecutionTools`, marked as deprecated and not used in `Agent`.
-   Fixed document preview and download in Agents Server chat:
    -   Resolved issue where source URLs with query parameters (e.g. from blob storage) were not matched correctly, preventing previews.
    -   Fixed download button for cross-origin files by implementing a fetch-and-download mechanism to bypass browser restrictions on `download` attribute.
-   Improve the chat UI responsiveness by allowing user interaction (sending messages) while waiting for the agent reply.
-   Fixed document preview modal for KNOWLEDGE sources in Agents Server chat:
    -   Resolved issue where document preview was showing "Agent Not Found" error due to invalid URL resolution
    -   Fixed preview to only load when a valid URL is available (checks for http:// or https://)
    -   Removed technical clutter (Citation ID, Source, URL fields) from the modal for a cleaner user experience
    -   Redesigned download button with modern styling matching the application's design system
    -   Added proper error handling when preview is unavailable, showing a user-friendly message
    -   Simplified modal header to show only document name (without file extension) for better readability
-   Fixed image generation caching to consider all generation parameters (model, size, quality, style) in the cache key, ensuring that changing these parameters generates a new image instead of returning a cached one from a previous generation with different settings.
-   Fixed image generation caching to include input images (attachments) in the cache key, ensuring that using the same prompt with different input images generates new results.
-   Improved self-learning experience in `Agent` class:
    -   The agent now returns the generated answer immediately before starting the self-learning process.
    -   Self-learning is performed asynchronously in the background.
    -   A "Self learning" chip is displayed during the learning phase, similar to tool usage chips.
    -   This enhances user experience by eliminating the wait time for self-learning completion.
-   Enhanced codebase by using explicit types instead of type inference across multiple files in `src/`, `apps/`, and `scripts/` directories to improve readability and maintainability.
-   Fix width of the message in the chat by adding a minimum width and improving layout for short messages.
-   Use model `gemini-3-pro-image-preview` for the agent of Avatar Images
-   Updated `openai` from `4.63.0` to `6.18.0` and fixed all resulting type errors.
-   Resolved `zod` peer dependency conflicts between `@ai-sdk/deepseek` and `@openai/agents` by using `overrides` in `package.json`.
-   Fixed `node-fetch` declaration issue in `LindatAutomaticTranslator.ts` by using native `URLSearchParams` and removing `node-fetch` import.
