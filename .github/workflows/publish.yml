# âš ï¸ WARNING: This code has been generated so that any manual changes will be overwritten
name: ğŸ”¼ Publish new version
on:
    push:
        tags:
            - v*
jobs:
    publish-npm:
        name: Publish on NPM package registry
        runs-on: ubuntu-latest
        timeout-minutes: 120
        permissions:
            contents: read
            id-token: write
        strategy:
            matrix:
                package:
                    - anthropic-claude
                    - azure-openai
                    - browser
                    - cli
                    - color
                    - components
                    - core
                    - deepseek
                    - documents
                    - editable
                    - fake-llm
                    - google
                    - javascript
                    - legacy-documents
                    - markdown-utils
                    - markitdown
                    - node
                    - ollama
                    - openai
                    - pdf
                    - remote-client
                    - remote-server
                    - templates
                    - types
                    - utils
                    - vercel
                    - website-crawler
                    - wizard
                    - promptbook
                    - ptbk
        steps:
            - name: ğŸ”½ Checkout
              uses: actions/checkout@v4
            - name: ğŸ”½ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: https://registry.npmjs.org/
            - name: ğŸ”½ Install dependencies
              run: npm ci
            - name: ğŸ”½ Clone book submodule
              run: git submodule update --init --recursive
            - name: ğŸ§ª Test | Name discrepancies
              run: npm run test-name-discrepancies
            - name: ğŸ§ª Test | Spellcheck
              run: npm run test-spellcheck
            - name: ğŸ§ª Test | Lint
              run: npm run test-lint
            - name: ğŸ§ª Test | Types
              run: npm run test-types
            - name: ğŸ§ª Test | Books
              run: npm run test-books
              env:
                  OPENAI_API_KEY: ${{secrets.OPENAI_API_KEY}}
            - name: ğŸ­ Make | Promptbook Collection
              run: npm run make-promptbook-collection
              env:
                  OPENAI_API_KEY: ${{secrets.OPENAI_API_KEY}}
            - name: ğŸ­ Make | ğŸ†š Update Version in Config
              run: npm run update-version-in-config
            - name: ğŸ­ Make | Generate Packages
              run: npm run generate-packages
            - name: ğŸ­ Make | Generate .bookc from Examples
              run: npm run generate-examples-bookc
              env:
                  OPENAI_API_KEY: ${{secrets.OPENAI_API_KEY}}
            - name: ğŸ­ Make | Generate Documentation
              run: npm run generate-documentation
              env:
                  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
            - name: ğŸ­ Make | Import Markdowns
              run: npm run import-markdowns
            - name: ğŸ­ Make | Generate OpenAPI Types
              run: npm run generate-openapi-types
            - name: ğŸ”¼ Publish ${{ matrix.package }}
              working-directory: ./packages/${{ matrix.package }}
              run: npm publish --provenance --access public
              env:
                  NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
    publish-docker:
        name: Publish Docker image to DockerHub
        needs: publish-npm
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - name: ğŸ”½ Checkout
              uses: actions/checkout@v4
            - name: ï¿½ Login to DockerHub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USER }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}
            - name: ï¿½ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: https://registry.npmjs.org/
            - name: ï¿½ Install dependencies
              run: npm ci
            - name: ğŸ”½ Clone book submodule
              run: git submodule update --init --recursive
            - name: ğŸ†š Update version in Dockerfile
              run: npx ts-node ./scripts/update-version-in-config/update-version-in-config.ts
            - name: ğŸ†š Load current version into the environment
              run: echo "VERSION=$(node -p 'require(`./package.json`).version')" >>
                  $GITHUB_ENV
            - name: ğŸ‘â€ï¿½ Log version from previous step
              run: echo $VERSION
            - name: ğŸ‘â€ğŸ—¨ Log contents of the Dockerfile
              run: cat Dockerfile
            - name: ğŸ­ğŸ”¼ Build and Push Docker Image
              uses: docker/build-push-action@v2
              with:
                  context: .
                  push: true
                  tags: hejny/promptbook:${{ env.VERSION }}
