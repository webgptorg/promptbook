<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Plynulý contenteditable se zvýrazněním</title>
        <style>
            body {
                font-family: sans-serif;
                padding: 2rem;
                background: #f9f9f9;
            }

            .editor {
                width: 100%;
                min-height: 150px;
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 1rem;
                background: white;
                outline: none;
                white-space: pre-wrap;
                word-break: break-word;
            }

            b {
                color: #d00;
            }
        </style>
    </head>
    <body>
        <h2>contenteditable</h2>
        <div class="editor" contenteditable="true"></div>

        <h2>contenteditable++</h2>
        <div id="editor" class="editor" contenteditable="true"></div>

        <h2>Textarea</h2>
        <textarea class="editor"></textarea>

        <script>
            const editor = document.getElementById('editor');

            editor.addEventListener('input', () => {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const cursorPosition = getCaretCharacterOffsetWithin(editor);

                // Získáme čistý text
                const text = editor.innerText;
                const highlighted = highlightWords(text);

                // Nastavíme nový HTML obsah jen pokud se změnil
                if (editor.innerHTML !== highlighted) {
                    editor.innerHTML = highlighted;
                    setCaretPosition(editor, cursorPosition);
                }
            });

            function highlightWords(text) {
                // Nahraď "ahoj" za tučné
                return text.replace(/(ahoj)/gi, '<b>$1</b>');
            }

            // Pomocné funkce pro pozici kurzoru
            function getCaretCharacterOffsetWithin(element) {
                const selection = window.getSelection();
                let caretOffset = 0;
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    caretOffset = preCaretRange.toString().length;
                }
                return caretOffset;
            }

            function setCaretPosition(element, chars) {
                const range = document.createRange();
                const selection = window.getSelection();
                range.setStart(element.firstChild || element, 0);

                let nodeStack = [element],
                    charCount = 0,
                    node;
                while ((node = nodeStack.pop())) {
                    if (node.nodeType === 3) {
                        // text node
                        const nextCharCount = charCount + node.length;
                        if (chars <= nextCharCount) {
                            range.setStart(node, chars - charCount);
                            break;
                        }
                        charCount = nextCharCount;
                    } else {
                        let i = node.childNodes.length;
                        while (i--) nodeStack.push(node.childNodes[i]);
                    }
                }

                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        </script>
    </body>
</html>
