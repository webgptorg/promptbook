import { REMOTE_SERVER_URLS } from '../servers';
import { Color, grayscale, lighten } from './_packages/color.index';
import type { CsvSettings } from './formats/csv/CsvSettings';
import type { IntermediateFilesStrategy } from './types/IntermediateFilesStrategy';
import type { string_app_id, string_email, string_name, string_promptbook_server_url } from './types/typeAliases';
import { saturate } from './utils/color/operators/saturate';
import { just } from './utils/organization/just';

/**
 * Warning message for the generated sections and files files
 *
 * @private within the repository
 */
export const GENERATOR_WARNING = `‚ö†Ô∏è WARNING: This code has been generated so that any manual changes will be overwritten`;

/**
 * Name for the Promptbook
 *
 * TODO: [üóΩ] Unite branding and make single place for it
 *
 * @public exported from `@promptbook/core`
 */
export const NAME = `Promptbook`;

/**
 * Email of the responsible person
 *
 * @public exported from `@promptbook/core`
 */
export const ADMIN_EMAIL: string_email = 'pavol@ptbk.io';

/**
 * Name of the responsible person for the Promptbook on GitHub
 *
 * @public exported from `@promptbook/core`
 */
export const ADMIN_GITHUB_NAME: string_name = 'hejny';

/**
 * Claim for the Promptbook
 *
 * TODO: [üóΩ] Unite branding and make single place for it
 *
 * @public exported from `@promptbook/core`
 */
export const CLAIM = `Turn your company's scattered knowledge into AI ready books`;
//            <- TODO: [üêä] Pick the best claim

/**
 * Color of the Promptbook
 *
 * TODO: [üóΩ] Unite branding and make single place for it
 *
 * @public exported from `@promptbook/core`
 */
export const PROMPTBOOK_COLOR = Color.fromHex('#79EAFD');
// <- TODO: [üß†][üàµ] Using `Color` here increases the package size approx 3kb, maybe remove it

/**
 * Colors for syntax highlighting in the `<BookEditor/>`
 *
 * TODO: [üóΩ] Unite branding and make single place for it
 *
 * @public exported from `@promptbook/core`
 */
export const PROMPTBOOK_SYNTAX_COLORS = {
    TITLE: Color.fromHex('#244EA8'),
    LINE: Color.fromHex('#eeeeee'),
    COMMITMENT: Color.fromHex('#DA0F78'),
    PARAMETER: Color.fromHex('#8e44ad'),
} as const satisfies Record<string_name, Color>;
// <- TODO: [üß†][üàµ] Using `Color` here increases the package size approx 3kb, maybe remove it

/**
 * Chat color of the Promptbook (in chat)
 *
 * TODO: [üóΩ] Unite branding and make single place for it
 *
 * @public exported from `@promptbook/core`
 */
export const PROMPTBOOK_CHAT_COLOR = PROMPTBOOK_COLOR.then(lighten(0.1)).then(saturate(0.9)).then(grayscale(0.9));
// <- TODO: [üß†][üàµ] Using `Color` and `lighten`, `saturate`,... here increases the package size approx 3kb, maybe remove it

/**
 * Color of the user (in chat)
 *
 * TODO: [üóΩ] Unite branding and make single place for it
 *
 * @public exported from `@promptbook/core`
 */
export const USER_CHAT_COLOR = Color.fromHex('#1D4ED8');
// <- TODO: [üß†][üàµ] Using `Color` here increases the package size approx 3kb, maybe remove it

/**
 * When the title is not provided, the default title is used
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_BOOK_TITLE = `‚ú® Untitled Book`;

/**
 * When the title of task is not provided, the default title is used
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_TASK_TITLE = `Task`;

/**
 * When the title of the prompt task is not provided, the default title is used
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_PROMPT_TASK_TITLE = `Prompt`;

/**
 * When the pipeline is flat and no name of return parameter is provided, this name is used
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_BOOK_OUTPUT_PARAMETER_NAME = 'result';

/**
 * Maximum file size limit
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

/**
 * Threshold value that determines when a dataset is considered "big"
 * and may require special handling or optimizations
 *
 * For example, when error occurs in one item of the big dataset, it will not fail the whole pipeline
 *
 * @public exported from `@promptbook/core`
 */
export const BIG_DATASET_TRESHOLD = 50;

/**
 * Placeholder text used to represent a placeholder value of failed operation
 *
 * @public exported from `@promptbook/core`
 */
export const FAILED_VALUE_PLACEHOLDER = '!?';

/**
 * Placeholder text used to represent operations or values that are still in progress
 * or awaiting completion in UI displays and logging
 *
 * @public exported from `@promptbook/core`
 */
export const PENDING_VALUE_PLACEHOLDER = '‚Ä¶';

/**
 * Warning message for the generated sections and files files
 *
 * @private within the repository
 */
export const GENERATOR_WARNING_BY_PROMPTBOOK_CLI = `‚ö†Ô∏è WARNING: This code has been generated by \`@promptbook/cli\` so that any manual changes will be overwritten`;

/**
 * Warning message for the automatically generated sections of `.env` files
 *
 * @private within the repository
 */
export const GENERATOR_WARNING_IN_ENV = `Note: Added by Promptbook`;

// <- TODO: [üß†] Better system for generator warnings - not always "code" and "by `@promptbook/cli`"

/**
 * The maximum number of iterations for a loops
 *
 * @private within the repository - too low-level in comparison with other `MAX_...`
 */
export const LOOP_LIMIT = 1000;

/**
 * The maximum number of iterations for a loops which adds characters one by one
 *
 * @private within the repository - too low-level in comparison with other `MAX_...`
 */
export const CHARACTER_LOOP_LIMIT = 100000;

/**
 * Strings to represent various values in the context of parameter values
 *
 * @public exported from `@promptbook/utils`
 */
export const VALUE_STRINGS = {
    empty: '(nothing; empty string)',
    null: '(no value; null)',
    undefined: '(unknown value; undefined)',

    nan: '(not a number; NaN)',
    infinity: '(infinity; ‚àû)',
    negativeInfinity: '(negative infinity; -‚àû)',

    unserializable: '(unserializable value)',
    circular: '(circular JSON)',
} as const;

/**
 * Small number limit
 *
 * @public exported from `@promptbook/utils`
 */
export const SMALL_NUMBER = 0.001;

/**
 * Timeout for the connections in milliseconds
 *
 * @private within the repository - too low-level in comparison with other `MAX_...`
 */
export const CONNECTION_TIMEOUT_MS = 7 * 1000;

// <- TODO: [‚è≥] Standardize timeouts, Make DEFAULT_TIMEOUT_MS as global constant

/**
 * How many times to retry the connections
 *
 * @private within the repository - too low-level in comparison with other `MAX_...`
 */
export const CONNECTION_RETRIES_LIMIT = 5;

/**
 * Short time interval to prevent race conditions in milliseconds
 *
 * @private within the repository - too low-level in comparison with other `MAX_...`
 */
export const IMMEDIATE_TIME = 10;

/**
 * The maximum length of the (generated) filename
 *
 * @public exported from `@promptbook/core`
 */
export const MAX_FILENAME_LENGTH = 30;

/**
 * Strategy for caching the intermediate results for knowledge sources
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_INTERMEDIATE_FILES_STRATEGY: IntermediateFilesStrategy = 'HIDE_AND_KEEP';
//                                                     <- TODO: [üò°] Change to 'VISIBLE'

/**
 * The maximum number of (LLM) tasks running in parallel
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_MAX_PARALLEL_COUNT = 5; // <- TODO: [ü§π‚Äç‚ôÇÔ∏è]

/**
 * The maximum number of attempts to execute LLM task before giving up
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_MAX_EXECUTION_ATTEMPTS = 7; // <- TODO: [ü§π‚Äç‚ôÇÔ∏è]

/**
 * The maximum depth to which knowledge sources will be scraped when building a knowledge base.
 * This prevents infinite recursion and limits resource usage.
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_MAX_KNOWLEDGE_SOURCES_SCRAPING_DEPTH = 3;
// <- TODO: [üêù]

/**
 * The maximum total number of knowledge sources that will be scraped in a single operation.
 * This acts as a global limit to avoid excessive resource consumption.
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_MAX_KNOWLEDGE_SOURCES_SCRAPING_TOTAL = 200;
// <- TODO: [üêù]

/**
 * Where to store your books
 * This is kind of a "src" for your books
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_BOOKS_DIRNAME = './books';
// <- TODO: [üïù] Make also `BOOKS_DIRNAME_ALTERNATIVES`

// TODO: Just `.promptbook` in config, hardcode subfolders like `download-cache` or `execution-cache`

/**
 * Where to store the temporary downloads
 *
 * Note: When the folder does not exist, it is created recursively
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_DOWNLOAD_CACHE_DIRNAME = './.promptbook/download-cache';

/**
 * Where to store the cache of executions for promptbook CLI
 *
 * Note: When the folder does not exist, it is created recursively
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_EXECUTION_CACHE_DIRNAME = './.promptbook/execution-cache';

/**
 * Where to store the scrape cache
 *
 * Note: When the folder does not exist, it is created recursively
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_SCRAPE_CACHE_DIRNAME = './.promptbook/scrape-cache';

/**
 * Id of application for the CLI when using remote server
 *
 * @public exported from `@promptbook/core`
 */
export const CLI_APP_ID: string_app_id = 'cli';

/**
 * Id of application for the playground
 *
 * @public exported from `@promptbook/core`
 */
export const PLAYGROUND_APP_ID: string_app_id = 'playground';

/*
TODO: [üåÉ]
/**
 * Id of application for the wizard when using remote server
 *
 * @public exported from `@promptbook/core`
 * /
ex-port const WIZARD_APP_ID: string_app_id = 'wizard';
*/

/**
 * The name of the builded pipeline collection made by CLI `ptbk make` and for lookup in `createCollectionFromDirectory`
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_PIPELINE_COLLECTION_BASE_FILENAME = `index`;

/**
 * The thresholds for the relative time in the `moment` NPM package.
 *
 * @see https://momentjscom.readthedocs.io/en/latest/moment/07-customization/13-relative-time-threshold/
 * @private within the repository - too low-level in comparison with other constants
 */
export const MOMENT_ARG_THRESHOLDS = {
    ss: 3, // <- least number of seconds to be counted in seconds, minus 1. Must be set after setting the `s` unit or without setting the `s` unit.
} as const;

/**
 * Default remote server URL for the Promptbook
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_REMOTE_SERVER_URL: string_promptbook_server_url = REMOTE_SERVER_URLS[0]!.urls[0]!;

// <- TODO: [üßú‚Äç‚ôÇÔ∏è]

/**
 * Default settings for parsing and generating CSV files in Promptbook.
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_CSV_SETTINGS: CsvSettings = Object.freeze({
    delimiter: ',',
    quoteChar: '"',
    newline: '\n',
    skipEmptyLines: true,
});

/**
 * Controls whether verbose logging is enabled by default throughout the application.
 *
 * @public exported from `@promptbook/core`
 */
export let DEFAULT_IS_VERBOSE = false;

/**
 * Enables or disables verbose logging globally at runtime.
 *
 * Note: This is an experimental feature.
 *
 * @public exported from `@promptbook/core`
 */
export function SET_IS_VERBOSE(isVerbose: boolean): void {
    DEFAULT_IS_VERBOSE = isVerbose;
}

/**
 * Controls whether auto-installation of dependencies is enabled by default.
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_IS_AUTO_INSTALLED = false;

/**
 * Default simulated duration for a task in milliseconds (used for progress reporting)
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_TASK_SIMULATED_DURATION_MS = 5 * 60 * 1000; // 5 minutes

/**
 * Function name for generated function via `ptbk make` to get the pipeline collection
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_GET_PIPELINE_COLLECTION_FUNCTION_NAME = `getPipelineCollection`;

/**
 * Default rate limits (requests per minute)
 *
 * Note: Adjust based on the provider tier you are have
 *
 * @public exported from `@promptbook/core`
 */
export const DEFAULT_MAX_REQUESTS_PER_MINUTE = 60;

/**
 * API request timeout in milliseconds
 * Can be overridden via API_REQUEST_TIMEOUT environment variable
 *
 * @public exported from `@promptbook/core`
 */
export const API_REQUEST_TIMEOUT = parseInt(process.env.API_REQUEST_TIMEOUT || '90000');

/**
 * URL of the Promptbook logo
 *
 * @public exported from `@promptbook/core`
 */
export const PROMPTBOOK_LOGO_URL = 'https://promptbook.studio/logos/logo-blue-white-256.png';

/**
 * Indicates whether pipeline logic validation is enabled. When true, the pipeline logic is checked for consistency.
 *
 * @private within the repository
 */
export const IS_PIPELINE_LOGIC_VALIDATED: boolean = just(
    /**/
    // Note: In normal situations, we check the pipeline logic:
    true,
    /**/

    /*/
    // When working on some new features, you can temporarily turn off the validation:
    false,
    /**/

    // Commit message:
    // [üîë] Temporarily **disable** pipeline validation
    // [üîí] **Enable** pipeline validation
);

/**
 * Indicates whether cost-prevention is enabled. When true, real API keys are prevented from being used in tests.
 *
 * @private within the repository
 */
export const IS_COST_PREVENTED: boolean = just(
    /*/
    // Note: In normal situations, we prevent ability to use real API keys in tests:
    true,
    /**/

    /**/
    // When working on preparations, you can temporarily turn off the prevention:
    false,
    /**/

    // Commit message:
    // [üîë] Temporarily **disable** cost-prevention
    // [üîí] **Enable** cost-prevention
);

/**
 * Note: [üíû] Ignore a discrepancy between file name and entity name
 * TODO: [üß†][üßú‚Äç‚ôÇÔ∏è] Maybe join remoteServerUrl and path into single value
 */
