import { describe, expect, it } from '@jest/globals';
import { parseEmailAddresses } from './parseEmailAddresses';

describe('how parseEmailAddresses works', () => {
    it('should work with single email', () => {
        expect(parseEmailAddresses('pavol@webgpt.cz')).toEqual([
            {
                fullName: null,
                baseEmail: 'pavol@webgpt.cz',
                fullEmail: 'pavol@webgpt.cz',
                plus: [],
            },
        ]);
    });

    it('should work with simple emails', () => {
        expect(parseEmailAddresses('pavol@webgpt.cz, jirka@webgpt.cz, tomas@webgpt.cz')).toEqual([
            {
                fullName: null,
                baseEmail: 'pavol@webgpt.cz',
                fullEmail: 'pavol@webgpt.cz',
                plus: [],
            },
            {
                fullName: null,
                baseEmail: 'jirka@webgpt.cz',
                fullEmail: 'jirka@webgpt.cz',
                plus: [],
            },
            {
                fullName: null,
                baseEmail: 'tomas@webgpt.cz',
                fullEmail: 'tomas@webgpt.cz',
                plus: [],
            },
        ]);
    });

    it('should work with fullname', () => {
        expect(
            parseEmailAddresses(
                'Pavol Hejn칳 <pavol@webgpt.cz>, Jirka <jirka@webgpt.cz>, "Tom치코 Studen칤k" <tomas@webgpt.cz>',
            ),
        ).toEqual([
            {
                fullName: 'Pavol Hejn칳',
                baseEmail: 'pavol@webgpt.cz',
                fullEmail: 'pavol@webgpt.cz',
                plus: [],
            },
            {
                fullName: 'Jirka',
                baseEmail: 'jirka@webgpt.cz',
                fullEmail: 'jirka@webgpt.cz',
                plus: [],
            },
            {
                fullName: 'Tom치코 Studen칤k',
                baseEmail: 'tomas@webgpt.cz',
                fullEmail: 'tomas@webgpt.cz',
                plus: [],
            },
        ]);
    });

    it('not confused by comma', () => {
        expect(parseEmailAddresses(', pavol@webgpt.cz, ')).toEqual([
            {
                fullName: null,
                fullEmail: 'pavol@webgpt.cz',
                baseEmail: 'pavol@webgpt.cz',
                plus: [],
            },
        ]);
    });

    it('works on real-life example', () => {
        expect(
            parseEmailAddresses(
                '"bob" <bob@bot.webgpt.cz>, "pavolto" <pavol+to@ptbk.io>, "Pavol" <pavol@collboard.com>',
            ),
        ).toEqual([
            {
                fullName: 'bob',
                fullEmail: 'bob@bot.webgpt.cz',
                baseEmail: 'bob@bot.webgpt.cz',
                plus: [],
            },
            {
                fullName: 'pavolto',
                fullEmail: 'pavol+to@ptbk.io',
                baseEmail: 'pavol@ptbk.io',
                plus: ['to'],
            },
            {
                fullName: 'Pavol',
                fullEmail: 'pavol@collboard.com',
                baseEmail: 'pavol@collboard.com',
                plus: [],
            },
        ]);
    });

    it('throws on invalid email adresses', () => {
        expect(() => parseEmailAddresses('Pavol, Hejn칳')).toThrowError(/Invalid email address/);
        expect(() => parseEmailAddresses('Pavol Hejn칳 <>')).toThrowError(/Invalid email address/);
        expect(() => parseEmailAddresses('Pavol Hejn칳, <@webgpt.cz>')).toThrowError(/Invalid email address/);
        expect(() => parseEmailAddresses('Pavol Hejn칳 <webgpt.cz>')).toThrowError(/Invalid email address/);
        expect(() => parseEmailAddresses('Pavol Hejn칳 <pavol@>')).toThrowError(/Invalid email address/);
        expect(() => parseEmailAddresses('Pavol Hejn칳 <a@b>,')).toThrowError(/Invalid email address/);
    });
});


/**
 * TODO: [游냚] This test fails because of aliased imports `import type { string_emails } from '@promptbook-local/types';`, fix it
 */
