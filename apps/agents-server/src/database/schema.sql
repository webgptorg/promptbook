
-- Note: This is primary source of truth for the database schema
--       In future we want to be compatible with more then Supabase so we keep SQL as main schema definition
--       To update, search for [ðŸ’½]



CREATE TABLE IF NOT EXISTS "EnvironmentVariable" (
    "id" BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "key" TEXT NOT NULL,
    "value" TEXT NOT NULL,
    "note" TEXT NULL,
    CONSTRAINT EnvironmentVariable_pkey PRIMARY KEY ("id"),
    CONSTRAINT EnvironmentVariable_key_key UNIQUE ("key")
);


CREATE TABLE IF NOT EXISTS "Agent" (
    "id" BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "agentName" TEXT NOT NULL,
    

    "createdAt" TIMESTAMP WITH TIME ZONE NOT NULL,
    "updatedAt" TIMESTAMP WITH TIME ZONE NULL,


    "agentHash" TEXT NOT NULL,
    "agentSource" TEXT NOT NULL,
    "promptbookEngineVersion" TEXT NOT NULL,
   
    "usage" JSONB NULL,
    "preparedModelRequirements" JSONB NULL,
    "preparedExternals" JSONB NULL,
    
    CONSTRAINT Agent_pkey PRIMARY KEY (id),
    CONSTRAINT Agent_agentName_key UNIQUE ("agentName")
);


CREATE TABLE IF NOT EXISTS "AgentHistory" (
    "id" BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "createdAt" TIMESTAMP WITH TIME ZONE NOT NULL,

    "agentName" TEXT NOT NULL,
    "agentHash" TEXT NOT NULL,
    "previousAgentHash" TEXT NULL,
    "agentSource" TEXT NOT NULL,
    "promptbookEngineVersion" TEXT NOT NULL,
);


CREATE TABLE IF NOT EXISTS "ChatHistory" (
    "id" BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "createdAt" TIMESTAMP WITH TIME ZONE NOT NULL,

    "messageHash" TEXT NOT NULL,
    "previousMessageHash" TEXT NULL,
    "agentName" TEXT NOT NULL,
    "agentHash" TEXT NOT NULL,
    "message" JSONB NOT NULL,

    -- Telemetry:
    "promptbookEngineVersion" TEXT NULL,
    "url" TEXT NULL COMMENT 'The URL where the chat was happening',
    "ip" TEXT NULL COMMENT 'The IP address of the user',
    "userAgent" TEXT NULL COMMENT 'The user agent (browser) of the user',
    "language" TEXT NULL COMMENT 'The language (from the browser) of the user',
    "platform" TEXT NULL COMMENT 'The platform of the user',
);


CREATE TABLE IF NOT EXISTS "ChatFeedback" (
    "id" BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "createdAt" TIMESTAMP WITH TIME ZONE NOT NULL,

    "agentName" TEXT NOT NULL,
    "agentHash" TEXT NOT NULL,
    "rating" TEXT NULL,
    "textRating" TEXT NULL,
    "chatThread" TEXT NULL,
    "userNote" TEXT NULL,
    "expectedAnswer" TEXT NULL,

    -- Telemetry:
    "promptbookEngineVersion" TEXT NULL,
    "url" TEXT NULL COMMENT 'The URL where the chat was happening',
    "ip" TEXT NULL COMMENT 'The IP address of the user',
    "userAgent" TEXT NULL COMMENT 'The user agent (browser) of the user',
    "language" TEXT NULL COMMENT 'The language (from the browser) of the user',
    "platform" TEXT NULL COMMENT 'The platform of the user',
    constraint ChatFeedback_pkey primary key (id)
);


/*
CREATE TABLE IF NOT EXISTS "AgentActionHistory" (
id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
createdAt TIMESTAMP WITH TIME ZONE NOT NULL,

);
*/


/*
CREATE TABLE IF NOT EXISTS "Xxx" (
id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
);
*/


-- TODO: !!!! Create propper database migrations