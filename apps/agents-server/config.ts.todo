// TODO: !!!! Use the configuration from ConfigChecker
// TODO: !!!! Load config from `EnvironmentVariable` table, `EnvironmentVariable` has priority over `process.env` from `.env`
// TODO: !!!! Move variables from Vercel -> Supabase



import { CLI_APP_ID } from '@promptbook/core';
import { string_app_id } from '@promptbook/types';
import { spaceTrim } from '@promptbook/utils';
import { ConfigChecker } from 'configchecker';
import type { DallePrompt } from './src/ai/text-to-image/dalle/interfaces/DallePrompt';
import { validateAgentSource } from './src/book-2.0/agent-source/string_agent_source';
import { maxdown } from './src/components/Content/Maxdown/maxdown';
import type { LightModeDarkMode } from './src/components/LightModeDarkMode/utils/LightModeDarkMode';
import { DigitalOceanSpaces } from './src/utils/cdn/classes/DigitalOceanSpaces';
import type { BrjappOptions } from './src/utils/client/BrjappConnector';
import { validateUserId } from './src/utils/client/validateUserId';
import { validateDomain } from './src/utils/domains/validateDomain';
import type { EmailAddress } from './src/utils/emails/Email';
import { parseEmailAddress } from './src/utils/emails/utils/parseEmailAddress';
import { isRunningInBrowser } from './src/utils/isRunningInWhatever';
import type { string_char_emoji } from './src/utils/typeAliasEmoji';
import type { string_domain, string_maxdown, string_name } from './src/utils/typeAliases';
import { isUrlOnPrivateNetwork } from './src/utils/validators/isUrlOnPrivateNetwork';
import { validateUuid } from './src/utils/validators/validateUuid';

const config = ConfigChecker.from({
    ...process.env,

    // Note: To expose env variables to the browser, using this seemingly strange syntax:
    //       @see https://nextjs.org/docs/pages/building-your-application/configuring/environment-variables#exposing-environment-variables-to-the-browser
    NEXT_PUBLIC_URL: process.env.NEXT_PUBLIC_URL,
    NEXT_PUBLIC_VERCEL_BRANCH_URL: process.env.NEXT_PUBLIC_VERCEL_BRANCH_URL,
    NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF: process.env.NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF,
    NEXT_PUBLIC_PROMPTBOOK_SERVER_URL: process.env.NEXT_PUBLIC_PROMPTBOOK_SERVER_URL,
    NEXT_PUBLIC_IMAGE_SERVER_URL: process.env.NEXT_PUBLIC_IMAGE_SERVER_URL,
    NEXT_PUBLIC_BROWSER_SERVER_URL: process.env.NEXT_PUBLIC_BROWSER_SERVER_URL,
    NEXT_PUBLIC_OUR_DOMAINS: process.env.NEXT_PUBLIC_OUR_DOMAINS,
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,

    // Auth service environment variables
    NEXT_PUBLIC_FACEBOOK_APP_ID: process.env.NEXT_PUBLIC_FACEBOOK_APP_ID,
    NEXT_PUBLIC_LINKEDIN_CLIENT_ID: process.env.NEXT_PUBLIC_LINKEDIN_CLIENT_ID,
    NEXT_PUBLIC_GITHUB_CLIENT_ID: process.env.NEXT_PUBLIC_GITHUB_CLIENT_ID,
    NEXT_PUBLIC_GOOGLE_CLIENT_ID: process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID,
});

export const NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF = config.get('NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF').value;

const NEXT_PUBLIC_VERCEL_BRANCH_URL = config.get('NEXT_PUBLIC_VERCEL_BRANCH_URL').value;

/**
 * TODO: [ðŸ§ ] Maybe rename to NEXT_PUBLIC_WEBGPT_URL
 */
export const NEXT_PUBLIC_URL = NEXT_PUBLIC_VERCEL_BRANCH_URL
    ? NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF === 'main'
        ? // Production:
          config.get('NEXT_PUBLIC_URL').url().required().value
        : // Preview branch:
          new URL(`https://${NEXT_PUBLIC_VERCEL_BRANCH_URL}/`)
    : // Local development:
      config.get('NEXT_PUBLIC_URL').url().required().value;

export const ADMIN_GITHUB_NAME: string_name = 'hejny';
export const ADMIN_EMAIL: EmailAddress = parseEmailAddress('pavol@webgpt.cz');
export const BOT_EMAIL: EmailAddress = parseEmailAddress('bot@bot.webgpt.cz');
export const RUKA_DOMAIN: string_domain = validateDomain('bot.webgpt.cz');
export const BOT_SIGNATURE: string_maxdown = maxdown`[âœ¨ ${APP_NAME} Bot](${NEXT_PUBLIC_URL.href})`;

/**
 * ðŸŒ’ Default color mode for Promptbook studio
 *
 * Note: This will be used in rare cases because most of the time system settings will be present
 * Note: Use ðŸŒ’ dark mode for promptbook studio and miniapps
 */
export const DEFAULT_STUDIO_LIGHT_MODE_DARK_MODE: LightModeDarkMode = 'DARK';

/**
 * ðŸŒ’ Default color mode for miniapps
 *
 * Note: This can be overridden by the miniapp itself
 */
export const DEFAULT_MINIAPP_LIGHT_MODE_DARK_MODE: LightModeDarkMode = 'LIGHT';

export const USE_DALLE_VERSION: 2 | 3 = 3;

export const USE_DALLE_MODEL_SETTINGS: DallePrompt['modelSettings'] = {
    style: 'vivid',
    quality: `standard`,
    // <- TODO: !! Play with theeese to achieve best results
};

export const NEXT_PUBLIC_PROMPTBOOK_SERVER_URL = config.get('NEXT_PUBLIC_PROMPTBOOK_SERVER_URL').url().required().value;
export const NEXT_PUBLIC_IMAGE_SERVER_URL = config.get('NEXT_PUBLIC_IMAGE_SERVER_URL').url().required().value;
export const NEXT_PUBLIC_BROWSER_SERVER_URL = config.get('NEXT_PUBLIC_BROWSER_SERVER_URL').url().required().value;

export const IS_DEVELOPMENT =
    isUrlOnPrivateNetwork(
        NEXT_PUBLIC_URL,
    ); /* <- TODO: Maybe pass NODE_ENV and not assume that local is automatically dev */
export const IS_PRODUCTION = !IS_DEVELOPMENT;

if (isRunningInBrowser()) {
    const enviromentLogText = IS_DEVELOPMENT ? ' (in development mode)' : '';
    const branchLogText =
        NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF && NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF !== 'main'
            ? ` (branch ${NEXT_PUBLIC_VERCEL_GIT_COMMIT_REF})`
            : '';

    // TODO: Also log " client ${provideClientIdWithoutValidation()}" and avoid error unhandledRejection ReferenceError: window is not defined @see https://vercel.com/hejny/1-2i/E2LhCdVbk9hjEa8dE9ww42vnkcTg
    console.info(
        `%câœ¨ ${APP_NAME}${enviromentLogText}${branchLogText} version ${APP_VERSION} running on ${NEXT_PUBLIC_URL.href} `,
        spaceTrim(`
            display: block;

            background-color: rgba(0, 0, 0, 0.13);
            border: 1px solid rgba(255, 255 ,255, 0.53);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 60px;
            overflow: clip;

            padding: 10px;
            padding-left: 15px;
            padding-right: 15px;

            display: flex;
            justify-content: center /* <-[x] */;
            align-items: center /* <-[y] */;
        `)
            .split('\n')
            .join(''),
    );
}

export const NEXT_PUBLIC_DEBUG = config.get('NEXT_PUBLIC_DEBUG').boolean().value;

export const NEXT_PUBLIC_OUR_DOMAINS = config.get('NEXT_PUBLIC_OUR_DOMAINS').list().required().value;

// TODO: !!!!!!!!!!! Make this more semantic, use named apps
export const PROMPTBOOK_STUDIO_APP_ID: string_app_id = '00fe1297-bbbe-4447-a321-cb7a1e010025';
export const RUKA_APP_ID: string_app_id = validateUserId('ccc3d0d7-2e28-4e12-9244-82440445c1fb');

/**
 * You can login to theese apps with your email and password using BRJAPP
 */
export const SUPPORTED_APPS_FOR_USER_LOGIN = [PROMPTBOOK_STUDIO_APP_ID, RUKA_APP_ID, CLI_APP_ID];

// TODO: [feature/brj-app] !!! Change to SHA256 hash user ids
export const SYSTEM_USER_ID = validateUserId('000d2940-4a35-4859-83a8-3c754ea5df51');
export const ANONYMOUS_USER_ID = validateUserId('6bbb20dc-cb55-4f19-b867-71ad263bb828');

/**
 * Salt for hashing emails to derive user IDs
 */
export const USER_ID_HASH_SALT = config.get('USER_ID_HASH_SALT').value;

export const ZERO_UUID = validateUuid('00000000-0000-0000-0000-000000000000');

/**
 * The number of pregenerated photobank images to offer to the user to choose from
 */
export const PHOTOBANK_SEARCH_IMAGES_COUNT = 4;

/**
 * Number of keywords reduction attempts until photobank give up and just pick random images
 */
export const OPTIMIZE_PHOTOBANK_MAX_SEARCH_DEPTH = 5;

export const NEXT_PUBLIC_SUPABASE_URL = config.get('NEXT_PUBLIC_SUPABASE_URL').url().required().value;
export const NEXT_PUBLIC_SUPABASE_ANON_KEY = config.get('NEXT_PUBLIC_SUPABASE_ANON_KEY').required().value;
export const SUPABASE_SERVICE_ROLE_KEY = config.get('SUPABASE_SERVICE_ROLE_KEY').value;

export const VERCEL_GIT_COMMIT_MESSAGE = config.get('VERCEL_GIT_COMMIT_MESSAGE').value;
export const VERCEL_GIT_COMMIT_SHA = config.get('VERCEL_GIT_COMMIT_SHA').value;

/**
 * @deprecated Use App instead
 */
export const OPENAI_API_KEY = config.get('OPENAI_API_KEY').value;

export const ELEVENLABS_API_KEY =
    config.get('ELEVENLABS_API_KEY').value || 'sk_895d7dc576352e55f6b81545951c711f0d55f66a3e015db7'; // <- TODO: [ðŸŸ¢] Remove this hardcoded api key

export const SENDGRID_API_KEY = config.get('SENDGRID_API_KEY').value;
export const ZEPTOMAIL_API_KEY = config.get('ZEPTOMAIL_API_KEY').value;

export const AZURE_COMPUTER_VISION_ENDPOINT = config.get('AZURE_COMPUTER_VISION_ENDPOINT').url().value;
export const AZURE_COMPUTER_VISION_KEY = config.get('AZURE_COMPUTER_VISION_KEY').value;

// TODO: [ðŸ§ ] How to do required only on server
export const CDN_BUCKET = config.get('CDN_BUCKET') /*.required([ðŸ“])*/.value;
export const NEXT_PUBLIC_CDN_PATH_PREFIX = config.get('NEXT_PUBLIC_CDN_PATH_PREFIX') /*.required([ðŸ“])*/.value;
export const CDN_ENDPOINT = config.get('CDN_ENDPOINT') /*.required([ðŸ“])*/.value;
export const CDN_ACCESS_KEY_ID = config.get('CDN_ACCESS_KEY_ID') /*.required([ðŸ“])*/.value;
export const CDN_SECRET_ACCESS_KEY = config.get('CDN_SECRET_ACCESS_KEY') /*.required([ðŸ“])*/.value;
export const NEXT_PUBLIC_CDN_PUBLIC_URL = config.get('NEXT_PUBLIC_CDN_PUBLIC_URL').url() /*.required([ðŸ“])*/.value;

export const CDN = (CDN_BUCKET &&
    // [ðŸ“]
    new DigitalOceanSpaces({
        bucket: CDN_BUCKET!,
        pathPrefix: NEXT_PUBLIC_CDN_PATH_PREFIX!,
        endpoint: CDN_ENDPOINT!,
        accessKeyId: CDN_ACCESS_KEY_ID!,
        secretAccessKey: CDN_SECRET_ACCESS_KEY!,
        cdnPublicUrl: NEXT_PUBLIC_CDN_PUBLIC_URL!,
        gzip: false /* <- TODO: Maybe just remove this functionality from WebGPT repository */,
    })) as DigitalOceanSpaces;

export const MIDJOURNEY_WHOLE_GALLERY_PATH = 'X:/Mythings/MidJourney';

export const PDFMK_URL = config.get('PDFMK_URL', `@see https://github.com/hejny/pdfmk-server`).url().value;
export const PDFMK_TOKEN = config.get('PDFMK_TOKEN', `@see https://github.com/hejny/pdfmk-server`).value;

export const BRJAPP_API_KEY = config.get('BRJAPP_API_KEY').value;

/**
 * Options for the BrjappConnector instance
 */
export const BRJAPP_OPTIONS: BrjappOptions = {
    userGroups: ['cli'],
    initialCredits: 500000,
};

export const CITATION_COLORS = [
    '#8a3ffc', // <- purple
    '#0f62fe', // <- blue
    '#42be65', // <- green
    '#ff832b', // <- orange
    '#ee5396', // <- pink
    '#f1c21b', // <- yellow
    '#007d79', // <- teal
    '#fa4d56', // <- red
    '#6fdc8c', // <- light green
    '#be95ff', // <- lavender
];

/**
 * Storage key for custom agents in localStorage
 */
export const CUSTOM_AGENTS_STORAGE_KEY = 'custom-agents';

/**
 * Default agent name for AI avatars
 */
export const DEFAULT_AGENT_NAME = 'AI Avatar';

export function getTagedDefaultAgentName(tag: `[${string | string_char_emoji}]`): string {
    console.trace(`${tag} getTagedDefaultAgentName called`);
    return `${DEFAULT_AGENT_NAME} ${tag}`;
}

/**
 * Initial agent source for new agents
 */
export const INITIAL_AGENT_SOURCE = validateAgentSource(
    spaceTrim(`
        ${DEFAULT_AGENT_NAME}

        PERSONA A friendly AI assistant that helps you with your tasks

    `),
);

// Auth services configurations:
export const NEXT_PUBLIC_FACEBOOK_APP_ID = config.get('NEXT_PUBLIC_FACEBOOK_APP_ID').value;
export const FACEBOOK_APP_SECRET = config.get('FACEBOOK_APP_SECRET').value;
export const NEXT_PUBLIC_LINKEDIN_CLIENT_ID = config.get('NEXT_PUBLIC_LINKEDIN_CLIENT_ID').value;
export const LINKEDIN_CLIENT_SECRET = config.get('LINKEDIN_CLIENT_SECRET').value;
export const NEXT_PUBLIC_GITHUB_CLIENT_ID = config.get('NEXT_PUBLIC_GITHUB_CLIENT_ID').value;
export const GITHUB_CLIENT_SECRET = config.get('GITHUB_CLIENT_SECRET').value;
export const NEXT_PUBLIC_GOOGLE_CLIENT_ID = config.get('NEXT_PUBLIC_GOOGLE_CLIENT_ID').value;
export const GOOGLE_CLIENT_SECRET = config.get('GOOGLE_CLIENT_SECRET').value;

// Apify configuration for social media scraping
export const APIFY_API_KEY = config.get('APIFY_API_KEY').value;

/**
 * Boilerplate discussion topics for the Arena
 */
export const ARENA_DISCUSSION_TOPICS = [
    'What is the future of AI?',
    'How can AI improve education?',
    'What are the ethical implications of AI?',
    'Will AI replace human jobs or create new ones?',
    'How should AI be regulated?',
    'What role will AI play in healthcare?',
    'Can AI be creative and artistic?',
    'How will AI change the way we work?',
    'What are the risks of artificial general intelligence?',
    'How can we ensure AI remains beneficial to humanity?',
    'Should AI have rights?',
    'How will AI impact privacy and surveillance?',
    'What is the role of AI in scientific discovery?',
    'How can AI help solve climate change?',
    'What are the philosophical implications of conscious AI?',

    // More conversational and diverse topics
    'Is remote work better than office work?',
    'Should social media be regulated more heavily?',
    'What makes a good leader in 2025?',
    'Is cryptocurrency the future of money?',
    'How important is work-life balance?',
    'Should everyone learn to code?',
    "What's the best way to combat misinformation?",
    'Is space exploration worth the investment?',
    'How do we fix the housing crisis?',
    "What's the ideal length for a work week?",
    'Should university education be free?',
    'How do we address mental health at work?',
    'Is nuclear energy the solution to climate change?',
    'What makes content go viral?',
    'How should we prepare for the next pandemic?',
];
